<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Settlement Reports — Transaction Intelligence</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="sidebar.css">
    <link rel="stylesheet" href="router-transitions.css">
     <link rel="stylesheet" href="cpt-reports.css">
    <link rel="stylesheet" href="settlement-reports.css">
    
    <style>
        /* Date Range Dropdown Styles */
        .custom-dropdown {
            position: relative;
            display: inline-block;
        }
        .custom-dropdown-trigger {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--cpt-border);
            border-radius: var(--cpt-radius);
            font-size: 14px;
            background: var(--cpt-surface);
            color: var(--cpt-text);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-width: 140px;
        }
        .custom-dropdown-trigger::after {
            content: '▼';
            font-size: 10px;
            color: var(--cpt-text-secondary);
            margin-left: 8px;
        }
        .custom-dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--cpt-surface);
            border: 1px solid var(--cpt-border);
            border-radius: var(--cpt-radius);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }
        .custom-dropdown-menu.active {
            display: block;
        }
        .custom-dropdown-option {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.15s;
        }
        .custom-dropdown-option:hover {
            background: var(--cpt-bg);
        }
        .custom-dropdown-option.selected {
            background: rgba(99, 91, 255, 0.1);
            color: var(--cpt-primary);
        }
        
        /* Custom Date Range Container */
        .custom-date-range-container {
            display: none;
            margin-top: 12px;
            padding: 16px;
            background: var(--cpt-surface);
            border: 1px solid var(--cpt-border);
            border-radius: var(--cpt-radius);
        }
        .custom-date-range-container.active {
            display: block;
        }
        .date-range-row {
            display: flex;
            gap: 12px;
            margin-bottom: 12px;
        }
        .date-range-field {
            flex: 1;
        }
        .date-range-field label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: var(--cpt-text-secondary);
            margin-bottom: 6px;
        }
        .date-range-actions {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script>
        if (!window.supabaseClient) {
            window.supabaseClient = window.supabase.createClient(
                'https://hzdybwclwqkcobpwxzoo.supabase.co',
                'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6ZHlid2Nsd3FrY29icHd4em9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzU4ODQsImV4cCI6MjA4MTc1MTg4NH0.e0mSI7Qp9sRaclOwP61guBNtwTVHYXc-TtVaUON67QU'
            );
        }
    </script>
    <script src="sidebar.js"></script>
    <script src="router.js"></script>
    
    </head>
<body>
    <script>
        // Force full page reload for Settlement Reports to load styles
        if (window.location.hash !== '#loaded') {
            window.location.hash = '#loaded';
            window.location.reload();
        }
    </script>
    <!-- Authenticated Content -->
    <div id="authenticatedContent" class="hidden">
        <!-- Sidebar will be inserted by SidebarComponent -->
        
        <!-- Main Content -->
        <div class="main-wrapper">
            <div class="cpt-dashboard">
                <div class="cpt-container">
                <div class="cpt-header">
                    <div class="cpt-header-left">
                        <h1>Settlement Reports</h1>
                        <p class="cpt-header-subtitle">Create and manage settlement reports for client payouts</p>
                    </div>
                </div>
                <div class="cpt-site-selector">
                    <div class="cpt-site-selector-label">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        Select Site
                    </div>
                    <select id="siteSelect" class="cpt-site-select" onchange="handleSiteChange()"><option value="">All Sites</option></select>
                    
                    <div class="cpt-site-selector-label" style="margin-left: 16px;">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        Date Range
                    </div>
                    <div class="custom-dropdown" style="min-width: 160px;">
                        <div class="custom-dropdown-trigger" id="dateRangeTrigger">All Time</div>
                        <div class="custom-dropdown-menu" id="dateRangeMenu"></div>
                    </div>
                    <input type="hidden" id="dateRange" value="all">
                    
                    <div class="cpt-site-indicator" id="siteIndicator" style="display: none;"><span id="txCount">0</span> unsettled transactions</div>
                </div>
                
                <!-- Custom Date Range Picker -->
                <div class="custom-date-range-container" id="customDateContainer">
                    <div class="date-range-row">
                        <div class="date-range-field">
                            <label>Start Date</label>
                            <input type="date" id="startDateValue" class="cpt-site-select">
                        </div>
                        <div class="date-range-field">
                            <label>End Date</label>
                            <input type="date" id="endDateValue" class="cpt-site-select">
                        </div>
                    </div>
                    <div class="date-range-actions">
                        <button class="cpt-btn cpt-btn-secondary cpt-btn-sm" onclick="cancelCustomDate()">Cancel</button>
                        <button class="cpt-btn cpt-btn-primary cpt-btn-sm" onclick="applyCustomDate()">Apply</button>
                    </div>
                </div>
                <div class="cpt-tabs">
                    <button class="cpt-tab active" data-tab="create" onclick="switchTab('create')">Create Report</button>
                    <button class="cpt-tab" data-tab="pending" onclick="switchTab('pending')">Pending<span class="cpt-tab-badge" id="pendingCount">0</span></button>
                    <button class="cpt-tab" data-tab="paid" onclick="switchTab('paid')">Paid<span class="cpt-tab-badge" id="paidCount">0</span></button>
                </div>
                <div id="createPanel" class="cpt-panel active">
                    <div class="cpt-table-card">
                        <div class="cpt-table-header">
                            <div><div class="cpt-table-title">Unsettled Transactions</div><div class="cpt-table-subtitle">Select completed transactions to include</div></div>
                            <div class="cpt-table-actions">
                                <button class="cpt-btn cpt-btn-secondary cpt-btn-sm" onclick="selectAll()">Select All</button>
                                <button class="cpt-btn cpt-btn-secondary cpt-btn-sm" onclick="deselectAll()">Deselect All</button>
                            </div>
                        </div>
                        <div class="cpt-selection-summary" id="selectionSummary">
                            <div class="cpt-selection-info">
                                <span class="cpt-selection-count"><strong id="selectedCount">0</strong> selected</span>
                                <span class="cpt-selection-amount" id="selectedAmount">$0.00</span>
                            </div>
                            <button class="cpt-btn cpt-btn-primary" onclick="openCreateModal()">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                                Create Settlement Report
                            </button>
                        </div>
                        <div class="cpt-adjustments-section" id="adjustmentsSection" style="display:none;"></div>
                        <div class="cpt-pending-blocker" id="pendingReportBlocker" style="display:none;"></div>
                        <div class="cpt-table-wrapper">
                            <table class="cpt-table">
                                <thead><tr><th style="width:50px"><input type="checkbox" class="cpt-checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th><th>Date</th><th>Customer</th><th>Amount</th><th>Status</th><th>Trans ID</th></tr></thead>
                                <tbody id="transactionsBody"><tr><td colspan="6"><div class="cpt-loading"><div class="cpt-spinner"></div><div>Loading...</div></div></td></tr></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="pendingPanel" class="cpt-panel">
                    <div class="cpt-table-card">
                        <div class="cpt-table-header"><div><div class="cpt-table-title">Pending Settlement Reports</div><div class="cpt-table-subtitle">Reports awaiting payment</div></div></div>
                        <div class="cpt-table-wrapper">
                            <table class="cpt-table"><thead><tr><th>Report #</th><th>Site</th><th>Transactions</th><th>Payout</th><th>Created</th><th>Actions</th></tr></thead><tbody id="pendingReportsBody"><tr><td colspan="6"><div class="cpt-loading"><div class="cpt-spinner"></div><div>Loading...</div></div></td></tr></tbody></table>
                        </div>
                    </div>
                </div>
                <div id="paidPanel" class="cpt-panel">
                    <div class="cpt-table-card">
                        <div class="cpt-table-header"><div><div class="cpt-table-title">Paid Settlement Reports</div><div class="cpt-table-subtitle">Completed settlements</div></div></div>
                        <div class="cpt-table-wrapper">
                            <table class="cpt-table"><thead><tr><th>Report #</th><th>Site</th><th>Transactions</th><th>Payout</th><th>Paid</th><th>Actions</th></tr></thead><tbody id="paidReportsBody"><tr><td colspan="6"><div class="cpt-loading"><div class="cpt-spinner"></div><div>Loading...</div></div></td></tr></tbody></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="cpt-modal-overlay" id="createModal">
        <div class="cpt-modal">
            <div class="cpt-modal-header"><h3 class="cpt-modal-title">Create Settlement Report</h3><button class="cpt-modal-close" onclick="closeCreateModal()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="cpt-modal-body"><div class="cpt-report-summary" id="createModalSummary"></div><div class="cpt-form-group"><label class="cpt-form-label">Notes (optional)</label><textarea class="cpt-notes-input" id="reportNotes" placeholder="Add notes..."></textarea></div></div>
            <div class="cpt-modal-footer"><button class="cpt-btn cpt-btn-secondary" onclick="closeCreateModal()">Cancel</button><button class="cpt-btn cpt-btn-primary" onclick="createReport()" id="confirmCreateBtn">Create Report</button></div>
        </div>
    </div>
    <div class="cpt-modal-overlay" id="viewModal">
        <div class="cpt-modal" style="max-width:900px">
            <div class="cpt-modal-header"><h3 class="cpt-modal-title" id="viewModalTitle">Report</h3><button class="cpt-modal-close" onclick="closeViewModal()"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg></button></div>
            <div class="cpt-modal-body" id="viewModalBody"></div>
            <div class="cpt-modal-footer" id="viewModalFooter"><button class="cpt-btn cpt-btn-secondary" onclick="closeViewModal()">Close</button></div>
        </div>
    </div>
    <script>
        var sb = window.supabaseClient;
        var currentUserId = null, currentSite = '', allTransactions = [], filteredTransactions = [], selectedTransactions = new Set(), pendingReports = [], paidReports = [];
        var pendingAdjustments = []; // Adjustments for post-settlement refunds/chargebacks
        var sitePricing = null; // Pricing configuration for selected site
        var currentDateRange = 'all'; // Current date range filter
        var customStartDate = null, customEndDate = null; // Custom date range values
        
        async function init() {
            const { data: { session } } = await sb.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUserId = session.user.id;
            
            // Initialize sidebar
            SidebarComponent.init({ supabase: window.supabaseClient });
            
            // Initialize router (only runs once)
            if (typeof Router !== 'undefined' && !Router.isReady()) {
                Router.init({
                    contentSelector: '.main-wrapper',
                    transitionDuration: 100
                });
            }
            
            // Update user info in sidebar
            updateSidebarUser(session.user.email);
            
            // Show authenticated content
            document.getElementById('authenticatedContent').classList.remove('hidden');
            
            await loadTransactions();
            await loadReports();
            initDateRangeDropdown();
            initDatePickers();
        }

        async function loadTransactions() {
            const tbody = document.getElementById('transactionsBody');
            tbody.innerHTML = '<tr><td colspan="6"><div class="cpt-loading"><div class="cpt-spinner"></div><div>Loading...</div></div></td></tr>';
            try {
                // Load all complete transactions (trans_type = 'complete')
                const { data, error } = await sb
                    .from('cpt_data')
                    .select('*')
                    .eq('trans_type', 'complete')
                    .order('transaction_date', { ascending: false });
                
                if (error) {
                    console.error('Query error:', error);
                    throw error;
                }
                
                console.log('Total complete transactions:', data?.length || 0);
                
                // Filter out transactions that are already in a settlement report (pending or paid)
                // A transaction is available if: not settled AND not in any report
                allTransactions = (data || []).filter(t => !t.is_settled && !t.settlement_report_id);
                console.log('Available for settlement:', allTransactions.length);
                
                if (data && data.length > 0) {
                    console.log('Sample transaction:', data[0]);
                    console.log('Site names in data:', [...new Set(data.map(t => t.site_name))]);
                }
                
                populateSiteDropdown();
                applyFilter();
            } catch (e) {
                console.error('Error loading transactions:', e);
                tbody.innerHTML = '<tr><td colspan="6"><div class="cpt-empty"><div class="cpt-empty-title">Error</div><div class="cpt-empty-text">' + e.message + '</div></div></td></tr>';
            }
        }

        function populateSiteDropdown() {
            console.log('Populating site dropdown from', allTransactions.length, 'transactions');
            const sites = [...new Set(allTransactions.map(t => t.site_name).filter(Boolean))].sort();
            console.log('Found sites:', sites);
            const sel = document.getElementById('siteSelect');
            sel.innerHTML = '<option value="">All Sites</option>' + sites.map(s => '<option value="' + s + '">' + s + '</option>').join('');
        }

        function handleSiteChange() {
            currentSite = document.getElementById('siteSelect').value;
            selectedTransactions.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            applyFilter();
            loadAdjustmentsForSite();
            loadPricingForSite();
            checkPendingReportsForSite();
            updateSelectionSummary();
        }

        async function loadPricingForSite() {
            sitePricing = null;
            if (!currentSite) return;
            
            try {
                const { data, error } = await sb
                    .from('site_pricing')
                    .select('*')
                    .eq('site_name', currentSite)
                    .single();
                
                if (!error && data) {
                    sitePricing = data;
                    console.log('Loaded pricing for site:', sitePricing);
                } else {
                    console.log('No pricing found for site:', currentSite);
                }
            } catch (e) {
                console.log('No pricing configured for site');
            }
        }

        async function checkPendingReportsForSite() {
            const blocker = document.getElementById('pendingReportBlocker');
            if (!blocker) return;
            
            if (!currentSite) {
                blocker.style.display = 'none';
                document.getElementById('selectionSummary').style.pointerEvents = '';
                return;
            }
            
            try {
                const { data: pendingForSite } = await sb
                    .from('settlement_reports')
                    .select('id, report_number, created_at, net_amount')
                    .eq('site_name', currentSite)
                    .eq('status', 'pending');
                
                if (pendingForSite && pendingForSite.length > 0) {
                    const report = pendingForSite[0];
                    blocker.style.display = 'block';
                    blocker.innerHTML = `
                        <div class="cpt-blocker-icon">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                        </div>
                        <div class="cpt-blocker-content">
                            <div class="cpt-blocker-title">Pending Report Exists</div>
                            <div class="cpt-blocker-text">
                                <strong>${report.report_number}</strong> (${formatCurrency(report.net_amount)}) is still pending for this site.
                                <br>You must mark it as paid or delete it before creating a new report.
                            </div>
                            <div class="cpt-blocker-actions">
                                <button class="cpt-btn cpt-btn-secondary cpt-btn-sm" onclick="viewReport('${report.id}')">View Report</button>
                                <button class="cpt-btn cpt-btn-success cpt-btn-sm" onclick="markAsPaid('${report.id}')">Mark as Paid</button>
                                <button class="cpt-btn cpt-btn-sm" style="background:var(--cpt-error);color:white" onclick="deleteReport('${report.id}', false)">Delete</button>
                            </div>
                        </div>
                    `;
                    // Disable the create button
                    document.getElementById('selectionSummary').style.pointerEvents = 'none';
                } else {
                    blocker.style.display = 'none';
                    document.getElementById('selectionSummary').style.pointerEvents = '';
                }
            } catch (e) {
                console.error('Error checking pending reports:', e);
            }
        }

        async function loadAdjustmentsForSite() {
            pendingAdjustments = [];
            if (!currentSite) {
                renderAdjustmentsSection();
                return;
            }
            
            try {
                const { data, error } = await sb
                    .from('settlement_adjustments')
                    .select('*')
                    .eq('site_name', currentSite)
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                pendingAdjustments = data || [];
                console.log('Pending adjustments for site:', pendingAdjustments.length, pendingAdjustments);
                console.log('First adjustment processing_fee_credit:', pendingAdjustments[0]?.processing_fee_credit);
                renderAdjustmentsSection();
            } catch (e) {
                console.error('Error loading adjustments:', e);
            }
        }

        function renderAdjustmentsSection() {
            const container = document.getElementById('adjustmentsSection');
            if (!container) return;
            
            if (pendingAdjustments.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            const totalAdj = pendingAdjustments.reduce((sum, a) => sum + parseFloat(a.amount || 0), 0);
            
            container.style.display = 'block';
            container.innerHTML = `
                <div class="cpt-adjustments-header">
                    <div class="cpt-adjustments-title">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="20" height="20">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                        </svg>
                        Post-Settlement Adjustments
                    </div>
                    <div class="cpt-adjustments-total">-${formatCurrency(totalAdj)}</div>
                </div>
                <div class="cpt-adjustments-list">
                    ${pendingAdjustments.map(a => `
                        <div class="cpt-adjustment-item">
                            <div class="cpt-adjustment-info">
                                <span class="cpt-adjustment-reason ${a.reason}">${a.reason}</span>
                                <span class="cpt-adjustment-customer">${a.original_cust_name || 'Unknown'}</span>
                                <span class="cpt-adjustment-ref">from ${a.original_settlement_report_number}</span>
                            </div>
                            <div class="cpt-adjustment-amount">-${formatCurrency(a.amount)}</div>
                        </div>
                    `).join('')}
                </div>
                <div class="cpt-adjustments-note">These adjustments will be automatically applied to the next settlement report for this site.</div>
            `;
        }

        function applyFilter() {
            // First filter by site
            let filtered = currentSite ? allTransactions.filter(t => t.site_name === currentSite) : [...allTransactions];
            
            // Then filter by date range
            const { startDate, endDate } = getDateFilterRange();
            if (startDate || endDate) {
                filtered = filtered.filter(t => {
                    const txDate = new Date(t.transaction_date);
                    if (startDate && txDate < startDate) return false;
                    if (endDate && txDate > endDate) return false;
                    return true;
                });
            }
            
            filteredTransactions = filtered;
            const ind = document.getElementById('siteIndicator'), cnt = document.getElementById('txCount');
            if (filteredTransactions.length > 0) { ind.style.display = 'flex'; cnt.textContent = filteredTransactions.length; } else { ind.style.display = 'none'; }
            renderTransactionsTable();
        }

        function renderTransactionsTable() {
            const tbody = document.getElementById('transactionsBody');
            if (filteredTransactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6"><div class="cpt-empty"><div class="cpt-empty-icon"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div><div class="cpt-empty-title">All caught up!</div><div class="cpt-empty-text">No unsettled transactions</div></div></td></tr>';
                return;
            }
            tbody.innerHTML = filteredTransactions.map(t => {
                const key = t.cust_session + '|||' + t.transaction_date, sel = selectedTransactions.has(key), d = new Date(t.transaction_date), amt = parseFloat(t.cust_amount || 0);
                let ind = ''; if (t.is_refund) ind += '<span class="cpt-row-indicator refund">R</span>'; if (t.is_chargeback) ind += '<span class="cpt-row-indicator chargeback">CB</span>';
                return '<tr class="' + (sel ? 'selected' : '') + '" onclick="toggleTransaction(\'' + key + '\')"><td onclick="event.stopPropagation()"><input type="checkbox" class="cpt-checkbox" ' + (sel ? 'checked' : '') + ' onchange="toggleTransaction(\'' + key + '\')"></td><td><div class="cpt-cell-date"><span class="cpt-cell-date-main">' + d.toLocaleDateString('en-US', {month:'short',day:'numeric',year:'numeric'}) + '</span><span class="cpt-cell-date-time">' + d.toLocaleTimeString('en-US', {hour:'numeric',minute:'2-digit'}) + '</span></div></td><td><div class="cpt-cell-customer"><span class="cpt-cell-customer-name">' + (t.cust_name || '—') + '</span><span class="cpt-cell-customer-email">' + (t.cust_email_ad || '—') + '</span></div></td><td><span class="cpt-cell-amount ' + ((t.is_refund || t.is_chargeback) ? 'negative' : '') + '">' + formatCurrency(amt) + '</span>' + ind + '</td><td><span class="cpt-status-badge ' + (t.is_refund ? 'refund' : t.is_chargeback ? 'chargeback' : 'complete') + '">' + (t.is_refund ? 'Refund' : t.is_chargeback ? 'Chargeback' : 'Complete') + '</span></td><td><span class="cpt-cell-id">' + (t.cust_trans_id || '—') + '</span></td></tr>';
            }).join('');
        }

        function toggleTransaction(key) { if (selectedTransactions.has(key)) selectedTransactions.delete(key); else selectedTransactions.add(key); renderTransactionsTable(); updateSelectionSummary(); }
        function selectAll() { 
            console.log('Selecting all', filteredTransactions.length, 'filtered transactions');
            filteredTransactions.forEach(t => {
                const key = t.cust_session + '|||' + t.transaction_date;
                selectedTransactions.add(key);
            });
            console.log('Total selected:', selectedTransactions.size);
            document.getElementById('selectAllCheckbox').checked = true; 
            renderTransactionsTable(); 
            updateSelectionSummary(); 
        }
        function deselectAll() { selectedTransactions.clear(); document.getElementById('selectAllCheckbox').checked = false; renderTransactionsTable(); updateSelectionSummary(); }
        function toggleSelectAll() { document.getElementById('selectAllCheckbox').checked ? selectAll() : deselectAll(); }

        function updateSelectionSummary() {
            const sum = document.getElementById('selectionSummary'), cnt = selectedTransactions.size;
            if (cnt === 0) { sum.classList.remove('visible'); return; }
            sum.classList.add('visible');
            document.getElementById('selectedCount').textContent = cnt;
            const totals = calculateSelectedTotals();
            
            // Calculate adjustment total
            const adjTotal = pendingAdjustments.reduce((s, a) => s + parseFloat(a.amount || 0), 0);
            const netAfterAdj = totals.net - adjTotal;
            
            // Show net after adjustments if there are any
            if (adjTotal > 0) {
                document.getElementById('selectedAmount').innerHTML = `${formatCurrency(totals.net)} <span style="color:var(--cpt-error);margin-left:4px;">- ${formatCurrency(adjTotal)}</span> = <strong>${formatCurrency(netAfterAdj)}</strong>`;
            } else {
                document.getElementById('selectedAmount').textContent = formatCurrency(totals.net);
            }
        }

        function calculateSelectedTotals() {
            let gross = 0, refunds = 0, chargebacks = 0;
            selectedTransactions.forEach(key => { 
                const parts = key.split('|||'), s = parts[0], d = parts[1], t = allTransactions.find(tx => tx.cust_session === s && tx.transaction_date === d); 
                if (t) { 
                    const a = parseFloat(t.cust_amount || 0); 
                    if (t.is_refund) {
                        // Refunded transaction: original sale was refunded, net = $0
                        // Track the amount for display purposes but don't add to gross
                        refunds += a;
                    } else if (t.is_chargeback) {
                        // Chargedback transaction: original sale was charged back, net = $0
                        // Track the amount for display purposes but don't add to gross
                        chargebacks += a;
                    } else {
                        // Normal completed transaction - counts toward payout
                        gross += a;
                    }
                }
            });
            // Net = gross only (refunds/chargebacks already netted to $0)
            return { gross, refunds, chargebacks, net: gross };
        }

        async function openCreateModal() {
            if (selectedTransactions.size === 0) return;
            
            // Check if blocked by pending report
            const blocker = document.getElementById('pendingReportBlocker');
            if (blocker && blocker.style.display !== 'none') {
                alert('You must resolve the pending report for this site before creating a new one.');
                return;
            }
            
            // Show loading on the create button
            const createBtn = document.querySelector('#selectionSummary .cpt-btn-primary');
            const originalBtnHTML = createBtn.innerHTML;
            createBtn.disabled = true;
            createBtn.innerHTML = '<div class="cpt-spinner" style="width:16px;height:16px;border-width:2px"></div> Loading...';
            
            try {
                // Refresh adjustments for the site (may have changed in another tab)
                if (currentSite) {
                    await loadAdjustmentsForSite();
                    console.log('Refreshed adjustments:', pendingAdjustments.length, pendingAdjustments);
                }
                
                // Refresh transaction data to get latest state (refunds/chargebacks may have changed)
                const selectedKeys = [...selectedTransactions];
                const sessions = selectedKeys.map(k => k.split('|||')[0]);
                
                const { data: freshData, error } = await sb
                    .from('cpt_data')
                    .select('*')
                    .in('cust_session', sessions);
                
                if (error) {
                    console.error('Error refreshing transaction data:', error);
                    alert('Error loading latest transaction data. Please refresh the page.');
                    return;
                }
                
                // Update allTransactions with fresh data
                const freshMap = new Map();
                (freshData || []).forEach(t => {
                    freshMap.set(t.cust_session + '|||' + t.transaction_date, t);
                });
                
                // Update our local data with fresh values
                allTransactions = allTransactions.map(t => {
                    const key = t.cust_session + '|||' + t.transaction_date;
                    return freshMap.get(key) || t;
                });
                
                // Also update filteredTransactions
                filteredTransactions = filteredTransactions.map(t => {
                    const key = t.cust_session + '|||' + t.transaction_date;
                    return freshMap.get(key) || t;
                });
                
                // Refresh the table to show any status changes
                renderTransactionsTable();
                
                const totals = calculateSelectedTotals();
                
                // Count refunds and chargebacks for fee calculation
                let refundCount = 0, chargebackCount = 0, successfulCount = 0;
                selectedTransactions.forEach(key => {
                    const parts = key.split('|||'), s = parts[0], d = parts[1];
                    const t = allTransactions.find(tx => tx.cust_session === s && tx.transaction_date === d);
                    if (t) {
                        if (t.is_refund) refundCount++;
                        else if (t.is_chargeback) chargebackCount++;
                        else successfulCount++;
                    }
                });
                
            let siteName = 'Multiple Sites'; const sites = new Set();
            selectedTransactions.forEach(key => { const parts = key.split('|||'), s = parts[0], d = parts[1], t = allTransactions.find(tx => tx.cust_session === s && tx.transaction_date === d); if (t && t.site_name) sites.add(t.site_name); });
            if (sites.size === 1) siteName = [...sites][0];
            
            // Calculate adjustments
            const adjTotal = pendingAdjustments.reduce((s, a) => s + parseFloat(a.amount || 0), 0);
            const netAfterAdj = totals.net - adjTotal;
            
            // Calculate fees based on pricing
            let feesHTML = '';
            let totalFees = 0;
            let processingFeeAmount = 0, transactionFeesTotal = 0, refundFeesTotal = 0, chargebackFeesTotal = 0;
            
            // Count adjustments by type for fees
            const adjRefundCount = pendingAdjustments.filter(a => a.reason === 'refund').length;
            const adjChargebackCount = pendingAdjustments.filter(a => a.reason === 'chargeback').length;
            
            // Calculate processing fee credit from REFUND adjustments only (chargebacks don't get credit)
            const processingFeeCredit = pendingAdjustments
                .filter(a => a.reason === 'refund')
                .reduce((sum, a) => sum + parseFloat(a.processing_fee_credit || 0), 0);
            
            // Total counts including adjustments
            const totalRefundCount = refundCount + adjRefundCount;
            const totalChargebackCount = chargebackCount + adjChargebackCount;
            const totalTransactionCount = successfulCount + refundCount + chargebackCount;
            
            console.log('Fee calculation debug:', {
                refundCount,
                adjRefundCount,
                totalRefundCount,
                chargebackCount,
                adjChargebackCount,
                totalChargebackCount,
                sitePricing,
                hasPricing: !!sitePricing
            });
            
            if (sitePricing) {
                // Processing fee is on gross (successful sales only)
                processingFeeAmount = totals.gross * (parseFloat(sitePricing.percentage_fee) / 100);
                
                // Transaction fee applies to ALL transactions (successful + refunds + chargebacks)
                // because the initial transaction still happened
                transactionFeesTotal = totalTransactionCount * parseFloat(sitePricing.per_transaction_fee || 0);
                
                // Refund fees: transactions in this report + adjustments from previous reports
                refundFeesTotal = totalRefundCount * parseFloat(sitePricing.refund_fee || 0);
                
                // Chargeback fees: transactions in this report + adjustments from previous reports
                chargebackFeesTotal = totalChargebackCount * parseFloat(sitePricing.chargeback_fee || 0);
                
                // Net fees = fees charged - credits
                totalFees = processingFeeAmount + transactionFeesTotal + refundFeesTotal + chargebackFeesTotal - processingFeeCredit;
                
                console.log('Computed fees:', {
                    processingFeeAmount,
                    transactionFeesTotal,
                    refundFeesTotal,
                    chargebackFeesTotal,
                    processingFeeCredit,
                    totalFees,
                    refundFeePer: sitePricing.refund_fee,
                    chargebackFeePer: sitePricing.chargeback_fee
                });
                
                feesHTML = `
                    <div style="grid-column: 1 / -1; border-top: 1px solid var(--cpt-border); margin-top: 8px; padding-top: 16px;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--cpt-purple); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            Processing Fees
                        </div>
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface-hover); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                            <span>Processing Fee (${parseFloat(sitePricing.percentage_fee).toFixed(2)}% of ${formatCurrency(totals.gross)})</span>
                            <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(processingFeeAmount)}</span>
                        </div>
                        ${parseFloat(sitePricing.per_transaction_fee) > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface-hover); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                            <span>Transaction Fee (${formatCurrency(sitePricing.per_transaction_fee)} × ${totalTransactionCount} transactions)</span>
                            <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(transactionFeesTotal)}</span>
                        </div>
                        ` : ''}
                        ${totalRefundCount > 0 && parseFloat(sitePricing.refund_fee) > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface-hover); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                            <span>Refund Fee (${formatCurrency(sitePricing.refund_fee)} × ${totalRefundCount} refund${totalRefundCount > 1 ? 's' : ''}${adjRefundCount > 0 ? ` <span style="color:var(--cpt-text-tertiary)">(${refundCount} in report + ${adjRefundCount} adj)</span>` : ''})</span>
                            <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(refundFeesTotal)}</span>
                        </div>
                        ` : ''}
                        ${totalChargebackCount > 0 && parseFloat(sitePricing.chargeback_fee) > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface-hover); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                            <span>Chargeback Fee (${formatCurrency(sitePricing.chargeback_fee)} × ${totalChargebackCount} chargeback${totalChargebackCount > 1 ? 's' : ''}${adjChargebackCount > 0 ? ` <span style="color:var(--cpt-text-tertiary)">(${chargebackCount} in report + ${adjChargebackCount} adj)</span>` : ''})</span>
                            <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(chargebackFeesTotal)}</span>
                        </div>
                        ` : ''}
                        ${processingFeeCredit > 0 ? `
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-success-bg); border-radius: 6px; margin-bottom: 6px; font-size: 13px; border: 1px solid var(--cpt-success);">
                            <span>Processing Fee Credit <span style="color:var(--cpt-text-tertiary)">(refunds only)</span></span>
                            <span style="font-family: var(--cpt-mono); color: var(--cpt-success); font-weight: 600;">+${formatCurrency(processingFeeCredit)}</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; padding: 8px 12px; font-size: 13px; font-weight: 600; border-top: 1px dashed var(--cpt-border); margin-top: 8px; padding-top: 12px;">
                            <span>Net Fees</span>
                            <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(totalFees)}</span>
                        </div>
                    </div>
                `;
            } else {
                feesHTML = `
                    <div style="grid-column: 1 / -1; border-top: 1px solid var(--cpt-border); margin-top: 8px; padding-top: 16px;">
                        <div style="padding: 16px; background: var(--cpt-warning-bg); border-radius: 8px; border: 1px solid var(--cpt-warning);">
                            <div style="font-size: 13px; font-weight: 600; color: var(--cpt-warning); margin-bottom: 4px;">No Pricing Configured</div>
                            <div style="font-size: 12px; color: var(--cpt-text-secondary);">Configure pricing for this site in <a href="site-pricing.html" style="color: var(--cpt-primary);">Site Pricing</a> to calculate fees.</div>
                        </div>
                    </div>
                `;
            }
            
            let adjustmentsHTML = '';
            if (pendingAdjustments.length > 0) {
                adjustmentsHTML = `
                    <div style="grid-column: 1 / -1; border-top: 1px solid var(--cpt-border); margin-top: 8px; padding-top: 16px;">
                        <div style="font-size: 13px; font-weight: 600; color: var(--cpt-warning); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                            </svg>
                            Post-Settlement Adjustments (${pendingAdjustments.length})
                        </div>
                        ${pendingAdjustments.map(a => `
                            <div style="padding: 8px 12px; background: var(--cpt-surface-hover); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span><span style="color: ${a.reason === 'refund' ? 'var(--cpt-purple)' : 'var(--cpt-error)'}; font-weight: 600; text-transform: uppercase; font-size: 10px;">${a.reason}</span> ${a.original_cust_name || 'Unknown'} <span style="color: var(--cpt-text-tertiary);">from ${a.original_settlement_report_number}</span></span>
                                    <span style="font-family: var(--cpt-mono); color: var(--cpt-error); font-weight: 600;">-${formatCurrency(a.amount)}</span>
                                </div>
                                ${(a.reason === 'refund' && parseFloat(a.processing_fee_credit || 0) > 0) ? `
                                <div style="display: flex; justify-content: space-between; margin-top: 4px; padding-top: 4px; border-top: 1px dashed var(--cpt-border); font-size: 12px; color: var(--cpt-text-secondary);">
                                    <span>Processing fee credit (${parseFloat(a.original_processing_fee_percent || 0).toFixed(2)}%)</span>
                                    <span style="font-family: var(--cpt-mono); color: var(--cpt-success);">+${formatCurrency(a.processing_fee_credit)}</span>
                                </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // Calculate merchant payout
            const merchantPayout = netAfterAdj - totalFees;
            
            // Store fee data for createReport
            window.currentReportFees = {
                processingFeePercent: sitePricing ? parseFloat(sitePricing.percentage_fee) : 0,
                processingFeeAmount,
                transactionFeePer: sitePricing ? parseFloat(sitePricing.per_transaction_fee || 0) : 0,
                transactionFeesTotal,
                refundFeePer: sitePricing ? parseFloat(sitePricing.refund_fee || 0) : 0,
                refundFeesTotal,
                chargebackFeePer: sitePricing ? parseFloat(sitePricing.chargeback_fee || 0) : 0,
                chargebackFeesTotal,
                processingFeeCredit,
                totalFees,
                refundCount: totalRefundCount,  // includes adjustments
                chargebackCount: totalChargebackCount,  // includes adjustments
                successfulCount,
                totalTransactionCount,
                adjRefundCount,
                adjChargebackCount
            };
            
            document.getElementById('createModalSummary').innerHTML = `
                <div class="cpt-report-stat"><div class="cpt-report-stat-label">Site</div><div class="cpt-report-stat-value">${siteName}</div></div>
                <div class="cpt-report-stat"><div class="cpt-report-stat-label">Transactions</div><div class="cpt-report-stat-value">${selectedTransactions.size}</div></div>
                <div class="cpt-report-stat"><div class="cpt-report-stat-label">Successful Sales</div><div class="cpt-report-stat-value positive">${formatCurrency(totals.gross)}</div></div>
                <div class="cpt-report-stat"><div class="cpt-report-stat-label">Refunded (net $0)</div><div class="cpt-report-stat-value" style="color:var(--cpt-text-tertiary)">${formatCurrency(totals.refunds)} <span style="font-size:11px">(${refundCount})</span></div></div>
                <div class="cpt-report-stat"><div class="cpt-report-stat-label">Chargebacks (net $0)</div><div class="cpt-report-stat-value" style="color:var(--cpt-text-tertiary)">${formatCurrency(totals.chargebacks)} <span style="font-size:11px">(${chargebackCount})</span></div></div>
                <div class="cpt-report-stat"><div class="cpt-report-stat-label">Subtotal</div><div class="cpt-report-stat-value">${formatCurrency(totals.net)}</div></div>
                ${adjustmentsHTML}
                ${adjTotal > 0 ? `
                    <div class="cpt-report-stat"><div class="cpt-report-stat-label">After Adjustments</div><div class="cpt-report-stat-value">${formatCurrency(netAfterAdj)}</div></div>
                ` : ''}
                ${feesHTML}
                
                <div style="grid-column: 1 / -1; border-top: 1px solid var(--cpt-border); margin-top: 8px; padding-top: 16px;">
                    <div style="font-size: 13px; font-weight: 600; color: var(--cpt-text-secondary); margin-bottom: 12px;">Manual Adjustment (optional)</div>
                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                        <div style="flex: 0 0 120px;">
                            <div style="display: flex; align-items: center; background: var(--cpt-surface-elevated); border: 1px solid var(--cpt-border-light); border-radius: 8px; overflow: hidden;">
                                <span style="padding: 10px 12px; background: var(--cpt-surface-hover); border-right: 1px solid var(--cpt-border-light); font-size: 14px; color: var(--cpt-text-secondary);">$</span>
                                <input type="number" step="0.01" id="manualAdjustment" value="0" style="flex:1; padding: 10px 12px; background: transparent; border: none; font-size: 14px; color: var(--cpt-text); font-family: var(--cpt-mono); width: 80px;" onchange="updateMerchantPayout()">
                            </div>
                            <div style="font-size: 11px; color: var(--cpt-text-tertiary); margin-top: 4px;">Negative = deduct</div>
                        </div>
                        <div style="flex: 1;">
                            <input type="text" id="manualAdjustmentNote" placeholder="Reason for adjustment..." style="width: 100%; padding: 10px 12px; background: var(--cpt-surface-elevated); border: 1px solid var(--cpt-border-light); border-radius: 8px; font-size: 14px; color: var(--cpt-text); font-family: var(--cpt-font);">
                        </div>
                    </div>
                </div>
                
                <div class="cpt-report-stat" style="grid-column: 1 / -1; background: var(--cpt-success-bg); border: 2px solid var(--cpt-success); margin-top: 16px;">
                    <div class="cpt-report-stat-label">Merchant Payout</div>
                    <div class="cpt-report-stat-value positive" style="font-size: 28px;" id="merchantPayoutDisplay">${formatCurrency(merchantPayout)}</div>
                </div>
            `;
            
            // Store base values for recalculation
            window.currentReportBase = {
                netAfterAdj,
                totalFees,
                merchantPayout
            };
            
            document.getElementById('reportNotes').value = '';
            document.getElementById('createModal').classList.add('active');
            } finally {
                // Restore button
                createBtn.disabled = false;
                createBtn.innerHTML = originalBtnHTML;
            }
        }
        function closeCreateModal() { document.getElementById('createModal').classList.remove('active'); }
        
        function updateMerchantPayout() {
            const manualAdj = parseFloat(document.getElementById('manualAdjustment').value) || 0;
            const base = window.currentReportBase || { merchantPayout: 0 };
            const newPayout = base.netAfterAdj - base.totalFees + manualAdj;
            document.getElementById('merchantPayoutDisplay').textContent = formatCurrency(newPayout);
        }

        async function createReport() {
            const btn = document.getElementById('confirmCreateBtn');
            btn.disabled = true; btn.innerHTML = '<div class="cpt-spinner" style="width:16px;height:16px;border-width:2px"></div> Creating...';
            try {
                const totals = calculateSelectedTotals(), notes = document.getElementById('reportNotes').value.trim();
                let minDate = null, maxDate = null; const txList = [], siteIds = new Set(), siteNames = new Set();
                
                console.log('Selected transactions:', selectedTransactions.size);
                
                selectedTransactions.forEach(key => { 
                    const parts = key.split('|||');
                    const s = parts[0], d = parts[1];
                    const t = allTransactions.find(tx => tx.cust_session === s && tx.transaction_date === d); 
                    if (t) { 
                        txList.push(t); 
                        if (t.site_id) siteIds.add(t.site_id); 
                        if (t.site_name) siteNames.add(t.site_name); 
                        const td = new Date(t.transaction_date); 
                        if (!minDate || td < minDate) minDate = td; 
                        if (!maxDate || td > maxDate) maxDate = td; 
                    } else {
                        console.warn('Could not find transaction for key:', key);
                    }
                });
                
                console.log('Transactions to include in report:', txList.length);
                
                if (txList.length === 0) {
                    throw new Error('No transactions found to include in report');
                }
                
                // Calculate adjustment totals
                const adjTotal = pendingAdjustments.reduce((s, a) => s + parseFloat(a.amount || 0), 0);
                const adjCount = pendingAdjustments.length;
                const netAfterAdj = totals.net - adjTotal;
                
                // Get fee data and manual adjustment
                const fees = window.currentReportFees || {};
                const manualAdj = parseFloat(document.getElementById('manualAdjustment')?.value) || 0;
                const manualAdjNote = document.getElementById('manualAdjustmentNote')?.value?.trim() || null;
                const merchantPayout = netAfterAdj - (fees.totalFees || 0) + manualAdj;
                
                console.log('Adjustments:', adjCount, 'totaling', adjTotal);
                console.log('Fees:', fees);
                console.log('Manual adjustment:', manualAdj, manualAdjNote);
                console.log('Merchant payout:', merchantPayout);
                
                const siteId = siteIds.size === 1 ? [...siteIds][0] : 'multiple', siteName = siteNames.size === 1 ? [...siteNames][0] : 'Multiple Sites';
                const { data: rn, error: e1 } = await sb.rpc('generate_settlement_report_number'); if (e1) throw e1;
                
                // Create report with adjustment and pricing info
                const { data: rpt, error: e2 } = await sb.from('settlement_reports').insert({ 
                    report_number: rn, 
                    site_id: siteId, 
                    site_name: siteName, 
                    status: 'pending', 
                    total_transactions: txList.length, 
                    gross_amount: totals.gross, 
                    refunds_amount: totals.refunds, 
                    chargebacks_amount: totals.chargebacks, 
                    net_amount: netAfterAdj,
                    adjustments_total: adjTotal,
                    adjustments_count: adjCount,
                    // Pricing/fee data
                    processing_fee_percent: fees.processingFeePercent || 0,
                    processing_fee_amount: fees.processingFeeAmount || 0,
                    transaction_fee_per: fees.transactionFeePer || 0,
                    transaction_fees_total: fees.transactionFeesTotal || 0,
                    refund_fee_per: fees.refundFeePer || 0,
                    refund_fees_total: fees.refundFeesTotal || 0,
                    chargeback_fee_per: fees.chargebackFeePer || 0,
                    chargeback_fees_total: fees.chargebackFeesTotal || 0,
                    processing_fee_credit: fees.processingFeeCredit || 0,
                    total_fees: fees.totalFees || 0,
                    manual_adjustment: manualAdj,
                    manual_adjustment_note: manualAdjNote,
                    merchant_payout: merchantPayout,
                    period_start: minDate?.toISOString(), 
                    period_end: maxDate?.toISOString(), 
                    created_by: currentUserId, 
                    notes: notes || null 
                }).select().single(); 
                if (e2) throw e2;
                
                console.log('Created report:', rpt.id, rpt.report_number);
                
                const items = txList.map(t => ({ settlement_report_id: rpt.id, cust_session: t.cust_session, transaction_date: t.transaction_date, cust_name: t.cust_name, cust_email: t.cust_email_ad, amount: parseFloat(t.cust_amount || 0), currency: t.currency || 'CAD', status: t.status, trans_type: t.trans_type, cust_trans_id: t.cust_trans_id, is_refund: t.is_refund || false, is_chargeback: t.is_chargeback || false }));
                const { error: e3 } = await sb.from('settlement_report_items').insert(items); if (e3) throw e3;
                
                console.log('Inserted', items.length, 'report items');
                
                // Update cpt_data to link transactions to this report (parallel)
                await Promise.all(txList.map(t => 
                    sb.from('cpt_data')
                        .update({ settlement_report_id: rpt.id })
                        .eq('cust_session', t.cust_session)
                        .eq('transaction_date', t.transaction_date)
                ));
                
                console.log('Updated', txList.length, 'transactions in cpt_data');
                
                // Apply adjustments - mark them as applied (parallel)
                if (pendingAdjustments.length > 0) {
                    await Promise.all(pendingAdjustments.map(adj => 
                        sb.from('settlement_adjustments')
                            .update({ 
                                status: 'applied', 
                                applied_to_settlement_id: rpt.id,
                                applied_at: new Date().toISOString()
                            })
                            .eq('id', adj.id)
                    ));
                    console.log('Applied', pendingAdjustments.length, 'adjustments to report');
                }
                
                closeCreateModal(); selectedTransactions.clear(); await loadTransactions(); await loadReports(); await checkPendingReportsForSite(); switchTab('pending');
            } catch (e) { console.error(e); alert('Error: ' + e.message); } finally { btn.disabled = false; btn.innerHTML = 'Create Report'; }
        }

        async function loadReports() {
            try {
                const { data: p } = await sb.from('settlement_reports').select('*').eq('status', 'pending').order('created_at', { ascending: false }); pendingReports = p || [];
                const { data: pd } = await sb.from('settlement_reports').select('*').eq('status', 'paid').order('paid_at', { ascending: false }); paidReports = pd || [];
                document.getElementById('pendingCount').textContent = pendingReports.length;
                document.getElementById('paidCount').textContent = paidReports.length;
                renderPendingReports(); renderPaidReports();
            } catch (e) { console.error(e); }
        }

        function renderPendingReports() {
            const tbody = document.getElementById('pendingReportsBody');
            if (pendingReports.length === 0) { tbody.innerHTML = '<tr><td colspan="6"><div class="cpt-empty"><div class="cpt-empty-title">No pending reports</div></div></td></tr>'; return; }
            tbody.innerHTML = pendingReports.map(r => '<tr onclick="viewReport(\'' + r.id + '\')"><td><span class="cpt-report-number">' + r.report_number + '</span></td><td>' + (r.site_name || '—') + '</td><td>' + r.total_transactions + '</td><td><span class="cpt-cell-amount">' + formatCurrency(r.merchant_payout || r.net_amount) + '</span></td><td>' + new Date(r.created_at).toLocaleDateString() + '</td><td onclick="event.stopPropagation()"><div style="display:flex;gap:8px"><button class="cpt-btn cpt-btn-secondary cpt-btn-sm" onclick="downloadReportCSV(\'' + r.id + '\')" title="Download Excel"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></button><button class="cpt-btn cpt-btn-success cpt-btn-sm" onclick="markAsPaid(\'' + r.id + '\')">Mark Paid</button><button class="cpt-btn cpt-btn-sm" style="background:var(--cpt-error);color:white" onclick="deleteReport(\'' + r.id + '\', false)">Delete</button></div></td></tr>').join('');
        }

        function renderPaidReports() {
            const tbody = document.getElementById('paidReportsBody');
            if (paidReports.length === 0) { tbody.innerHTML = '<tr><td colspan="6"><div class="cpt-empty"><div class="cpt-empty-title">No paid reports</div></div></td></tr>'; return; }
            tbody.innerHTML = paidReports.map(r => '<tr onclick="viewReport(\'' + r.id + '\')"><td><span class="cpt-report-number">' + r.report_number + '</span></td><td>' + (r.site_name || '—') + '</td><td>' + r.total_transactions + '</td><td><span class="cpt-cell-amount">' + formatCurrency(r.merchant_payout || r.net_amount) + '</span></td><td>' + (r.paid_at ? new Date(r.paid_at).toLocaleDateString() : '—') + '</td><td onclick="event.stopPropagation()"><div style="display:flex;gap:8px"><button class="cpt-btn cpt-btn-secondary cpt-btn-sm" onclick="downloadReportCSV(\'' + r.id + '\')" title="Download Excel"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg></button><button class="cpt-btn cpt-btn-secondary cpt-btn-sm" onclick="viewReport(\'' + r.id + '\')">View</button><button class="cpt-btn cpt-btn-sm" style="background:var(--cpt-error);color:white" onclick="deleteReport(\'' + r.id + '\', true)">Delete</button></div></td></tr>').join('');
        }

        async function viewReport(id) {
            const modal = document.getElementById('viewModal'), body = document.getElementById('viewModalBody'), footer = document.getElementById('viewModalFooter');
            body.innerHTML = '<div class="cpt-loading"><div class="cpt-spinner"></div><div>Loading...</div></div>'; modal.classList.add('active');
            try {
                const { data: r } = await sb.from('settlement_reports').select('*').eq('id', id).single();
                const { data: items } = await sb.from('settlement_report_items').select('*').eq('settlement_report_id', id).order('transaction_date', { ascending: false });
                
                // Load adjustments applied to this report
                const { data: adjustments } = await sb.from('settlement_adjustments').select('*').eq('applied_to_settlement_id', id).order('created_at', { ascending: false });
                
                document.getElementById('viewModalTitle').textContent = 'Report ' + r.report_number;
                
                // Build adjustments HTML if any
                let adjustmentsHTML = '';
                const adjTotal = parseFloat(r.adjustments_total || 0);
                const adjCount = r.adjustments_count || 0;
                
                if (adjCount > 0 && adjustments && adjustments.length > 0) {
                    adjustmentsHTML = `
                        <div style="margin: 24px 0; padding: 16px; background: var(--cpt-warning-bg); border-radius: var(--cpt-radius-sm); border: 1px solid var(--cpt-warning);">
                            <div style="font-weight: 600; color: var(--cpt-warning); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                Post-Settlement Adjustments Applied (${adjCount})
                            </div>
                            ${adjustments.map(a => `
                                <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                                    <span>
                                        <span style="color: ${a.reason === 'refund' ? 'var(--cpt-purple)' : 'var(--cpt-error)'}; font-weight: 600; text-transform: uppercase; font-size: 10px;">${a.reason}</span> 
                                        ${a.original_cust_name || 'Unknown'} 
                                        <span style="color: var(--cpt-text-tertiary);">from ${a.original_settlement_report_number}</span>
                                    </span>
                                    <span style="font-family: var(--cpt-mono); color: var(--cpt-error); font-weight: 600;">-${formatCurrency(a.amount)}</span>
                                </div>
                            `).join('')}
                            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--cpt-border); margin-top: 8px; font-weight: 600;">
                                <span>Total Adjustments</span>
                                <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(adjTotal)}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Calculate gross subtotal (before adjustments)
                const grossSubtotal = parseFloat(r.net_amount || 0) + adjTotal;
                
                // Build fees HTML if fees exist
                let feesHTML = '';
                const totalFees = parseFloat(r.total_fees || 0);
                if (totalFees > 0) {
                    feesHTML = `
                        <div style="margin: 24px 0; padding: 16px; background: var(--cpt-purple-bg); border-radius: var(--cpt-radius-sm); border: 1px solid var(--cpt-purple);">
                            <div style="font-weight: 600; color: var(--cpt-purple); margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Processing Fees
                            </div>
                            ${parseFloat(r.processing_fee_amount || 0) > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                                <span>Processing Fee (${parseFloat(r.processing_fee_percent || 0).toFixed(2)}%)</span>
                                <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(r.processing_fee_amount)}</span>
                            </div>
                            ` : ''}
                            ${parseFloat(r.transaction_fees_total || 0) > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                                <span>Transaction Fees (${formatCurrency(r.transaction_fee_per)} each)</span>
                                <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(r.transaction_fees_total)}</span>
                            </div>
                            ` : ''}
                            ${parseFloat(r.refund_fees_total || 0) > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                                <span>Refund Fees (${formatCurrency(r.refund_fee_per)} each)</span>
                                <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(r.refund_fees_total)}</span>
                            </div>
                            ` : ''}
                            ${parseFloat(r.chargeback_fees_total || 0) > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-surface); border-radius: 6px; margin-bottom: 6px; font-size: 13px;">
                                <span>Chargeback Fees (${formatCurrency(r.chargeback_fee_per)} each)</span>
                                <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(r.chargeback_fees_total)}</span>
                            </div>
                            ` : ''}
                            ${parseFloat(r.processing_fee_credit || 0) > 0 ? `
                            <div style="display: flex; justify-content: space-between; padding: 8px 12px; background: var(--cpt-success-bg); border-radius: 6px; margin-bottom: 6px; font-size: 13px; border: 1px solid var(--cpt-success);">
                                <span>Processing Fee Credit <span style="color:var(--cpt-text-tertiary)">(refunds only)</span></span>
                                <span style="font-family: var(--cpt-mono); color: var(--cpt-success); font-weight: 600;">+${formatCurrency(r.processing_fee_credit)}</span>
                            </div>
                            ` : ''}
                            <div style="display: flex; justify-content: space-between; padding-top: 8px; border-top: 1px solid var(--cpt-border); margin-top: 8px; font-weight: 600;">
                                <span>Net Fees</span>
                                <span style="font-family: var(--cpt-mono); color: var(--cpt-error);">-${formatCurrency(totalFees)}</span>
                            </div>
                        </div>
                    `;
                }
                
                // Manual adjustment HTML
                let manualAdjHTML = '';
                const manualAdj = parseFloat(r.manual_adjustment || 0);
                if (manualAdj !== 0) {
                    manualAdjHTML = `
                        <div style="margin: 24px 0; padding: 16px; background: var(--cpt-surface-elevated); border-radius: var(--cpt-radius-sm); border: 1px solid var(--cpt-border);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: 600; margin-bottom: 4px;">Manual Adjustment</div>
                                    ${r.manual_adjustment_note ? `<div style="font-size: 13px; color: var(--cpt-text-secondary);">${r.manual_adjustment_note}</div>` : ''}
                                </div>
                                <div style="font-family: var(--cpt-mono); font-size: 16px; font-weight: 600; color: ${manualAdj >= 0 ? 'var(--cpt-success)' : 'var(--cpt-error)'};">
                                    ${manualAdj >= 0 ? '+' : ''}${formatCurrency(manualAdj)}
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                body.innerHTML = `
                    <div class="cpt-report-summary">
                        <div class="cpt-report-stat"><div class="cpt-report-stat-label">Status</div><div class="cpt-report-stat-value"><span class="cpt-status-badge ${r.status}">${r.status}</span></div></div>
                        <div class="cpt-report-stat"><div class="cpt-report-stat-label">Site</div><div class="cpt-report-stat-value">${r.site_name}</div></div>
                        <div class="cpt-report-stat"><div class="cpt-report-stat-label">Transactions</div><div class="cpt-report-stat-value">${r.total_transactions}</div></div>
                        <div class="cpt-report-stat"><div class="cpt-report-stat-label">Successful Sales</div><div class="cpt-report-stat-value positive">${formatCurrency(r.gross_amount)}</div></div>
                        <div class="cpt-report-stat"><div class="cpt-report-stat-label">Refunded (net $0)</div><div class="cpt-report-stat-value" style="color:var(--cpt-text-tertiary)">${formatCurrency(r.refunds_amount)}</div></div>
                        <div class="cpt-report-stat"><div class="cpt-report-stat-label">Chargebacks (net $0)</div><div class="cpt-report-stat-value" style="color:var(--cpt-text-tertiary)">${formatCurrency(r.chargebacks_amount)}</div></div>
                        ${adjCount > 0 ? `
                            <div class="cpt-report-stat"><div class="cpt-report-stat-label">Subtotal</div><div class="cpt-report-stat-value">${formatCurrency(grossSubtotal)}</div></div>
                            <div class="cpt-report-stat"><div class="cpt-report-stat-label">Adjustments (${adjCount})</div><div class="cpt-report-stat-value negative">-${formatCurrency(adjTotal)}</div></div>
                        ` : ''}
                        ${totalFees > 0 ? `
                            <div class="cpt-report-stat"><div class="cpt-report-stat-label">Total Fees</div><div class="cpt-report-stat-value negative">-${formatCurrency(totalFees)}</div></div>
                        ` : ''}
                        ${manualAdj !== 0 ? `
                            <div class="cpt-report-stat"><div class="cpt-report-stat-label">Manual Adjustment</div><div class="cpt-report-stat-value ${manualAdj >= 0 ? 'positive' : 'negative'}">${manualAdj >= 0 ? '+' : ''}${formatCurrency(manualAdj)}</div></div>
                        ` : ''}
                        <div class="cpt-report-stat" style="grid-column: 1 / -1; background: var(--cpt-success-bg); border: 2px solid var(--cpt-success);">
                            <div class="cpt-report-stat-label">Merchant Payout</div>
                            <div class="cpt-report-stat-value positive" style="font-size: 28px;">${formatCurrency(r.merchant_payout || r.net_amount)}</div>
                        </div>
                    </div>
                    ${r.notes ? '<div style="margin-bottom:24px;padding:16px;background:var(--cpt-surface-elevated);border-radius:var(--cpt-radius-sm)"><strong>Notes:</strong> ' + r.notes + '</div>' : ''}
                    ${adjustmentsHTML}
                    ${feesHTML}
                    ${manualAdjHTML}
                    <div style="font-weight: 600; margin-bottom: 12px;">Transactions (${items.length})</div>
                    <div class="cpt-table-wrapper" style="max-height:300px;overflow-y:auto;border:1px solid var(--cpt-border);border-radius:var(--cpt-radius-sm)">
                        <table class="cpt-table">
                            <thead><tr><th>Date</th><th>Customer</th><th>Amount</th><th>Type</th></tr></thead>
                            <tbody>
                                ${items.map(i => `
                                    <tr>
                                        <td>${new Date(i.transaction_date).toLocaleDateString()}</td>
                                        <td><div class="cpt-cell-customer"><span class="cpt-cell-customer-name">${i.cust_name || '—'}</span><span class="cpt-cell-customer-email">${i.cust_email || '—'}</span></div></td>
                                        <td><span class="cpt-cell-amount ${(i.is_refund || i.is_chargeback) ? 'negative' : ''}">${formatCurrency(i.amount)}</span></td>
                                        <td>${i.is_refund ? '<span class="cpt-status-badge refund">Refund</span>' : i.is_chargeback ? '<span class="cpt-status-badge chargeback">Chargeback</span>' : '<span class="cpt-status-badge complete">Payment</span>'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                footer.innerHTML = '<button class="cpt-btn cpt-btn-secondary" onclick="closeViewModal()">Close</button><button class="cpt-btn cpt-btn-secondary" onclick="downloadReportCSV(\'' + r.id + '\')"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16" style="margin-right:6px"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>Download Excel</button><button class="cpt-btn" style="background:var(--cpt-error);color:white" onclick="deleteReport(\'' + r.id + '\', ' + (r.status === 'paid') + ')">Delete Report</button>' + (r.status === 'pending' ? '<button class="cpt-btn cpt-btn-success" onclick="markAsPaid(\'' + r.id + '\')">Mark Paid</button>' : '');
            } catch (e) { body.innerHTML = '<div class="cpt-empty"><div class="cpt-empty-title">Error</div><div class="cpt-empty-text">' + e.message + '</div></div>'; }
        }
        function closeViewModal() { document.getElementById('viewModal').classList.remove('active'); }

        async function markAsPaid(id) {
            if (!confirm('Mark this report as paid?')) return;
            
            // Show loading overlay
            const overlay = document.createElement('div');
            overlay.id = 'markPaidLoadingOverlay';
            overlay.innerHTML = `
                <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;">
                    <div style="background:var(--cpt-surface);padding:32px 48px;border-radius:var(--cpt-radius-md);text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                        <div class="cpt-spinner" style="width:32px;height:32px;margin:0 auto 16px;"></div>
                        <div style="font-weight:600;color:var(--cpt-text);">Marking as Paid...</div>
                        <div style="font-size:13px;color:var(--cpt-text-secondary);margin-top:4px;">Processing transactions</div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            try {
                // Get report info
                const { data: report } = await sb.from('settlement_reports').select('*').eq('id', id).single();
                
                // Get the report items
                const { data: items } = await sb.from('settlement_report_items').select('*').eq('settlement_report_id', id);
                
                // Fetch current state of ALL transactions in one query per batch
                const sessions = items.map(i => i.cust_session);
                const { data: currentTxs } = await sb
                    .from('cpt_data')
                    .select('cust_session, transaction_date, is_refund, is_chargeback, cust_name, cust_email_ad, cust_trans_id, cust_amount')
                    .in('cust_session', sessions);
                
                // Map for quick lookup
                const txMap = new Map();
                (currentTxs || []).forEach(tx => {
                    txMap.set(tx.cust_session + '|||' + tx.transaction_date, tx);
                });
                
                // Get site pricing for processing fee credit
                const { data: pricing } = await sb
                    .from('site_pricing')
                    .select('percentage_fee')
                    .eq('site_name', report.site_name)
                    .single();
                const processingFeePercent = pricing ? parseFloat(pricing.percentage_fee) : 0;
                
                // Check which adjustments already exist
                const { data: existingAdjs } = await sb
                    .from('settlement_adjustments')
                    .select('original_cust_session, original_transaction_date, reason')
                    .eq('original_settlement_report_id', id);
                
                const existingAdjKeys = new Set();
                (existingAdjs || []).forEach(adj => {
                    existingAdjKeys.add(adj.original_cust_session + '|||' + adj.original_transaction_date + '|||' + adj.reason);
                });
                
                // Find refunds/chargebacks that occurred AFTER the report was created
                // Only create adjustments if the transaction was NOT already refunded/chargedback when added to the report
                const adjustmentsToCreate = [];
                for (const item of items) {
                    const key = item.cust_session + '|||' + item.transaction_date;
                    const currentTx = txMap.get(key);
                    
                    // Check if status changed from normal → refund/chargeback AFTER being added to report
                    const wasRefundAtCreation = item.is_refund || false;
                    const wasChargebackAtCreation = item.is_chargeback || false;
                    const isRefundNow = currentTx?.is_refund || false;
                    const isChargebackNow = currentTx?.is_chargeback || false;
                    
                    // Only create adjustment if it WASN'T already refunded/chargedback when added to the report
                    // but IS now (meaning the refund/chargeback happened after the settlement was created)
                    if (isRefundNow && !wasRefundAtCreation) {
                        const adjKey = item.cust_session + '|||' + item.transaction_date + '|||refund';
                        if (existingAdjKeys.has(adjKey)) {
                            console.log('Adjustment already exists, skipping:', adjKey);
                            continue;
                        }
                        
                        const amount = parseFloat(currentTx.cust_amount || item.amount || 0);
                        // Refunds get processing fee credit
                        const processingFeeCredit = amount * (processingFeePercent / 100);
                        
                        adjustmentsToCreate.push({
                            site_id: report.site_id,
                            site_name: report.site_name,
                            original_cust_session: item.cust_session,
                            original_transaction_date: item.transaction_date,
                            original_cust_name: currentTx.cust_name || item.cust_name,
                            original_cust_email: currentTx.cust_email_ad || item.cust_email,
                            original_trans_id: currentTx.cust_trans_id || item.cust_trans_id,
                            original_settlement_report_id: id,
                            original_settlement_report_number: report.report_number,
                            amount: amount,
                            reason: 'refund',
                            status: 'pending',
                            original_processing_fee_percent: processingFeePercent,
                            processing_fee_credit: processingFeeCredit,
                            created_by: currentUserId
                        });
                    } else if (isChargebackNow && !wasChargebackAtCreation) {
                        const adjKey = item.cust_session + '|||' + item.transaction_date + '|||chargeback';
                        if (existingAdjKeys.has(adjKey)) {
                            console.log('Adjustment already exists, skipping:', adjKey);
                            continue;
                        }
                        
                        const amount = parseFloat(currentTx.cust_amount || item.amount || 0);
                        // Chargebacks do NOT get processing fee credit
                        
                        adjustmentsToCreate.push({
                            site_id: report.site_id,
                            site_name: report.site_name,
                            original_cust_session: item.cust_session,
                            original_transaction_date: item.transaction_date,
                            original_cust_name: currentTx.cust_name || item.cust_name,
                            original_cust_email: currentTx.cust_email_ad || item.cust_email,
                            original_trans_id: currentTx.cust_trans_id || item.cust_trans_id,
                            original_settlement_report_id: id,
                            original_settlement_report_number: report.report_number,
                            amount: amount,
                            reason: 'chargeback',
                            status: 'pending',
                            original_processing_fee_percent: 0,
                            processing_fee_credit: 0,
                            created_by: currentUserId
                        });
                    }
                }
                
                // Batch insert all adjustments at once (unique constraint will prevent duplicates at DB level too)
                if (adjustmentsToCreate.length > 0) {
                    const { error: adjError } = await sb.from('settlement_adjustments').insert(adjustmentsToCreate);
                    if (adjError) {
                        // Ignore unique constraint violations
                        if (adjError.code !== '23505') {
                            console.error('Error creating adjustments:', adjError);
                        }
                    }
                }
                
                // Mark report as paid
                await sb.from('settlement_reports').update({ status: 'paid', paid_at: new Date().toISOString(), paid_by: currentUserId }).eq('id', id);
                
                // Mark all transactions as settled (parallel)
                const settledAt = new Date().toISOString();
                await Promise.all(items.map(i => 
                    sb.from('cpt_data')
                        .update({ is_settled: true, settled_at: settledAt })
                        .eq('cust_session', i.cust_session)
                        .eq('transaction_date', i.transaction_date)
                ));
                
                if (adjustmentsToCreate.length > 0) {
                    alert(`Report marked as paid. ${adjustmentsToCreate.length} adjustment(s) created for refunds/chargebacks that will be applied to future settlements.`);
                }
                
                closeViewModal(); 
                await loadTransactions(); 
                await loadReports();
                await checkPendingReportsForSite();
                await loadAdjustmentsForSite();
            } catch (e) { 
                alert('Error: ' + e.message); 
            } finally {
                const loadingOverlay = document.getElementById('markPaidLoadingOverlay');
                if (loadingOverlay) loadingOverlay.remove();
            }
        }

        async function deleteReport(id, isPaid) {
            const confirmMsg = isPaid 
                ? 'Delete this PAID settlement report? The transactions will be unmarked as settled and become available again. Any adjustments will also be removed.'
                : 'Delete this settlement report? The transactions will become available again for a new report. Any adjustments will also be removed.';
            if (!confirm(confirmMsg)) return;
            
            // Show loading overlay
            const overlay = document.createElement('div');
            overlay.id = 'deleteLoadingOverlay';
            overlay.innerHTML = `
                <div style="position:fixed;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:10000;">
                    <div style="background:var(--cpt-surface);padding:32px 48px;border-radius:var(--cpt-radius-md);text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.3);">
                        <div class="cpt-spinner" style="width:32px;height:32px;margin:0 auto 16px;"></div>
                        <div style="font-weight:600;color:var(--cpt-text);">Deleting Report...</div>
                        <div style="font-size:13px;color:var(--cpt-text-secondary);margin-top:4px;">This may take a moment</div>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
            
            try {
                // Batch update: Clear settlement_report_id from all transactions in this report
                const updateData = { settlement_report_id: null };
                if (isPaid) {
                    updateData.is_settled = false;
                    updateData.settled_at = null;
                }
                await sb.from('cpt_data')
                    .update(updateData)
                    .eq('settlement_report_id', id);
                
                // Un-apply any adjustments that were applied to this report
                await sb.from('settlement_adjustments')
                    .update({ status: 'pending', applied_to_settlement_id: null, applied_at: null })
                    .eq('applied_to_settlement_id', id);
                
                // Delete adjustments created from this report
                await sb.from('settlement_adjustments')
                    .delete()
                    .eq('original_settlement_report_id', id);
                
                // Delete the report items
                await sb.from('settlement_report_items').delete().eq('settlement_report_id', id);
                
                // Delete the report itself
                const { error } = await sb.from('settlement_reports').delete().eq('id', id);
                if (error) throw error;
                
                closeViewModal(); 
                
                // Reset selections and site filter
                selectedTransactions.clear();
                currentSite = '';
                document.getElementById('siteSelect').value = '';
                document.getElementById('selectAllCheckbox').checked = false;
                
                await loadTransactions(); 
                await loadReports();
                checkPendingReportsForSite();
                renderAdjustmentsSection();
                updateSelectionSummary();
                switchTab('create');
            } catch (e) { 
                console.error('Delete error:', e);
                alert('Error deleting report: ' + e.message); 
            } finally {
                const loadingOverlay = document.getElementById('deleteLoadingOverlay');
                if (loadingOverlay) loadingOverlay.remove();
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.cpt-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.cpt-panel').forEach(p => p.classList.remove('active'));
            document.querySelector('.cpt-tab[data-tab="' + tab + '"]').classList.add('active');
            document.getElementById(tab + 'Panel').classList.add('active');
            
            // Reset selections when switching to create tab
            if (tab === 'create') {
                selectedTransactions.clear();
                currentSite = '';
                document.getElementById('siteSelect').value = '';
                document.getElementById('selectAllCheckbox').checked = false;
                applyFilter();
                checkPendingReportsForSite();
                renderAdjustmentsSection();
                updateSelectionSummary();
            }
        }

        async function downloadReportCSV(reportId) {
            try {
                // Get report data
                const { data: report } = await sb.from('settlement_reports').select('*').eq('id', reportId).single();
                if (!report) throw new Error('Report not found');
                
                // Get report items
                const { data: items } = await sb.from('settlement_report_items').select('*').eq('settlement_report_id', reportId).order('transaction_date', { ascending: true });
                if (!items || items.length === 0) throw new Error('No items found');
                
                // Use fee rates from the stored report
                const percentFee = parseFloat(report.processing_fee_percent || 0);
                const perTxFee = parseFloat(report.transaction_fee_per || 0);
                const refundFee = parseFloat(report.refund_fee_per || 0);
                const cbFee = parseFloat(report.chargeback_fee_per || 0);
                
                // Group items by week
                const weeklyData = {};
                items.forEach(item => {
                    const date = new Date(item.transaction_date);
                    const weekStart = getWeekStart(date);
                    const weekKey = weekStart.toISOString().split('T')[0];
                    
                    if (!weeklyData[weekKey]) {
                        weeklyData[weekKey] = {
                            weekStart: weekStart,
                            weekEnd: getWeekEnd(weekStart),
                            count: 0,
                            grossPayments: 0,
                            refundCount: 0,
                            refunds: 0,
                            chargebackCount: 0,
                            chargebacks: 0
                        };
                    }
                    
                    const amount = parseFloat(item.amount || 0);
                    
                    if (item.is_refund) {
                        weeklyData[weekKey].refundCount++;
                        weeklyData[weekKey].refunds += amount;
                    } else if (item.is_chargeback) {
                        weeklyData[weekKey].chargebackCount++;
                        weeklyData[weekKey].chargebacks += amount;
                    } else {
                        weeklyData[weekKey].count++;
                        weeklyData[weekKey].grossPayments += amount;
                    }
                });
                
                const sortedWeeks = Object.keys(weeklyData).sort();
                
                // Format dates
                const periodStart = report.period_start ? new Date(report.period_start).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
                const periodEnd = report.period_end ? new Date(report.period_end).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
                const generatedDate = new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                
                // Transaction counts
                const totalTxCount = parseInt(report.total_transactions || 0);
                const successfulCount = items.filter(i => !i.is_refund && !i.is_chargeback).length;
                const refundCountTotal = items.filter(i => i.is_refund).length;
                const chargebackCountTotal = items.filter(i => i.is_chargeback).length;
                
                // Fee amounts
                const storedProcessingFee = parseFloat(report.processing_fee_amount || 0);
                const storedTxFees = parseFloat(report.transaction_fees_total || 0);
                const storedRefundFees = parseFloat(report.refund_fees_total || 0);
                const storedCBFees = parseFloat(report.chargeback_fees_total || 0);
                const storedFeeCredit = parseFloat(report.processing_fee_credit || 0);
                const storedTotalFees = parseFloat(report.total_fees || 0);
                const adjustmentsTotal = parseFloat(report.adjustments_total || 0);
                const manualAdjustment = parseFloat(report.manual_adjustment || 0);
                const merchantPayout = parseFloat(report.merchant_payout || report.net_amount || 0);
                
                // Create workbook
                const workbook = new ExcelJS.Workbook();
                workbook.creator = 'Settlement Reports';
                workbook.created = new Date();
                
                const ws = workbook.addWorksheet('Settlement Statement', {
                    pageSetup: { paperSize: 9, orientation: 'landscape', fitToPage: true, fitToWidth: 1 },
                    views: [{ showGridLines: false }]
                });
                
                // Premium color palette
                const colors = {
                    primary: '0F172A',       // Slate 900
                    secondary: '334155',     // Slate 700
                    accent: '3B82F6',        // Blue 500
                    accentLight: 'DBEAFE',   // Blue 100
                    success: '10B981',       // Emerald 500
                    successLight: 'D1FAE5',  // Emerald 100
                    successDark: '059669',   // Emerald 600
                    danger: 'EF4444',        // Red 500
                    dangerLight: 'FEE2E2',   // Red 100
                    warning: 'F59E0B',       // Amber 500
                    muted: '64748B',         // Slate 500
                    light: 'F8FAFC',         // Slate 50
                    border: 'E2E8F0',        // Slate 200
                    white: 'FFFFFF'
                };
                
                // Set column widths for 10 columns (A-J)
                ws.columns = [
                    { width: 3 },   // A - margin
                    { width: 22 },  // B - labels
                    { width: 14 },  // C - values
                    { width: 14 },  // D
                    { width: 12 },  // E
                    { width: 12 },  // F
                    { width: 12 },  // G
                    { width: 12 },  // H
                    { width: 14 },  // I
                    { width: 3 },   // J - margin
                ];
                
                // Helper functions
                const setRowHeight = (rowNum, height) => { ws.getRow(rowNum).height = height; };
                const applyBorder = (cell, sides, style = 'thin', color = colors.border) => {
                    const borderStyle = { style, color: { argb: 'FF' + color } };
                    cell.border = {};
                    if (sides.includes('top')) cell.border.top = borderStyle;
                    if (sides.includes('bottom')) cell.border.bottom = borderStyle;
                    if (sides.includes('left')) cell.border.left = borderStyle;
                    if (sides.includes('right')) cell.border.right = borderStyle;
                };
                const fillRange = (startRow, endRow, startCol, endCol, color) => {
                    for (let r = startRow; r <= endRow; r++) {
                        for (let c = startCol; c <= endCol; c++) {
                            ws.getCell(r, c).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + color } };
                        }
                    }
                };
                
                let row = 1;
                
                // === TOP ACCENT BAR ===
                ws.mergeCells(`A${row}:J${row}`);
                ws.getCell(`A${row}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.accent } };
                setRowHeight(row, 6);
                row++;
                
                // === HEADER AREA ===
                fillRange(row, row + 4, 1, 10, colors.primary);
                
                // Title
                ws.mergeCells(`B${row}:I${row}`);
                setRowHeight(row, 8);
                row++;
                
                ws.mergeCells(`B${row}:E${row}`);
                const titleCell = ws.getCell(`B${row}`);
                titleCell.value = 'SETTLEMENT STATEMENT';
                titleCell.font = { bold: true, size: 22, color: { argb: 'FF' + colors.white }, name: 'Calibri Light' };
                titleCell.alignment = { vertical: 'middle' };
                
                // Statement number on right
                ws.mergeCells(`F${row}:I${row}`);
                const stmtNumCell = ws.getCell(`F${row}`);
                stmtNumCell.value = report.report_number;
                stmtNumCell.font = { bold: true, size: 22, color: { argb: 'FF' + colors.accentLight }, name: 'Calibri Light' };
                stmtNumCell.alignment = { horizontal: 'right', vertical: 'middle' };
                setRowHeight(row, 36);
                row++;
                
                // Subtitle line
                ws.mergeCells(`B${row}:E${row}`);
                const subtitleCell = ws.getCell(`B${row}`);
                subtitleCell.value = report.site_name;
                subtitleCell.font = { size: 14, color: { argb: 'FF' + colors.accentLight }, name: 'Calibri' };
                subtitleCell.alignment = { vertical: 'middle' };
                
                ws.mergeCells(`F${row}:I${row}`);
                const periodCell = ws.getCell(`F${row}`);
                periodCell.value = `${periodStart} — ${periodEnd}`;
                periodCell.font = { size: 12, color: { argb: 'FF' + colors.accentLight } };
                periodCell.alignment = { horizontal: 'right', vertical: 'middle' };
                setRowHeight(row, 24);
                row++;
                
                setRowHeight(row, 12);
                row++;
                
                // Spacer
                setRowHeight(row, 16);
                row++;
                
                // === SUMMARY CARDS ROW ===
                const cardStartRow = row;
                
                // Card 1: Total Transactions
                ws.mergeCells(`B${row}:C${row + 2}`);
                const card1 = ws.getCell(`B${row}`);
                card1.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.light } };
                applyBorder(card1, ['top', 'left', 'bottom', 'right'], 'thin', colors.border);
                
                ws.getCell(`B${row}`).value = { richText: [
                    { text: 'TRANSACTIONS\n', font: { size: 9, color: { argb: 'FF' + colors.muted }, bold: true } },
                    { text: `${totalTxCount}`, font: { size: 28, color: { argb: 'FF' + colors.primary }, bold: true } }
                ]};
                ws.getCell(`B${row}`).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                
                // Card 2: Gross Sales
                ws.mergeCells(`D${row}:E${row + 2}`);
                const card2 = ws.getCell(`D${row}`);
                card2.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.accentLight } };
                applyBorder(card2, ['top', 'left', 'bottom', 'right'], 'thin', colors.accent);
                
                const grossAmt = parseFloat(report.gross_amount || 0);
                ws.getCell(`D${row}`).value = { richText: [
                    { text: 'GROSS SALES\n', font: { size: 9, color: { argb: 'FF' + colors.accent }, bold: true } },
                    { text: `$${grossAmt.toLocaleString('en-US', { minimumFractionDigits: 2 })}`, font: { size: 24, color: { argb: 'FF' + colors.accent }, bold: true } }
                ]};
                ws.getCell(`D${row}`).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                
                // Card 3: Total Fees
                ws.mergeCells(`F${row}:G${row + 2}`);
                const card3 = ws.getCell(`F${row}`);
                card3.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.dangerLight } };
                applyBorder(card3, ['top', 'left', 'bottom', 'right'], 'thin', colors.danger);
                
                ws.getCell(`F${row}`).value = { richText: [
                    { text: 'TOTAL FEES\n', font: { size: 9, color: { argb: 'FF' + colors.danger }, bold: true } },
                    { text: `-$${storedTotalFees.toLocaleString('en-US', { minimumFractionDigits: 2 })}`, font: { size: 24, color: { argb: 'FF' + colors.danger }, bold: true } }
                ]};
                ws.getCell(`F${row}`).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                
                // Card 4: Net Payout (highlighted)
                ws.mergeCells(`H${row}:I${row + 2}`);
                const card4 = ws.getCell(`H${row}`);
                card4.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.success } };
                applyBorder(card4, ['top', 'left', 'bottom', 'right'], 'medium', colors.successDark);
                
                ws.getCell(`H${row}`).value = { richText: [
                    { text: 'NET PAYOUT\n', font: { size: 9, color: { argb: 'FF' + colors.white }, bold: true } },
                    { text: `$${merchantPayout.toLocaleString('en-US', { minimumFractionDigits: 2 })}`, font: { size: 24, color: { argb: 'FF' + colors.white }, bold: true } }
                ]};
                ws.getCell(`H${row}`).alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
                
                setRowHeight(row, 20);
                setRowHeight(row + 1, 28);
                setRowHeight(row + 2, 20);
                row += 3;
                
                // Spacer
                setRowHeight(row, 20);
                row++;
                
                // === WEEKLY TRANSACTION TABLE ===
                // Section header
                ws.mergeCells(`B${row}:I${row}`);
                const weeklyHeader = ws.getCell(`B${row}`);
                weeklyHeader.value = 'WEEKLY BREAKDOWN';
                weeklyHeader.font = { bold: true, size: 11, color: { argb: 'FF' + colors.secondary } };
                weeklyHeader.border = { bottom: { style: 'medium', color: { argb: 'FF' + colors.accent } } };
                setRowHeight(row, 24);
                row++;
                
                setRowHeight(row, 8);
                row++;
                
                // Table headers
                let feeComponents = [];
                if (percentFee > 0) feeComponents.push(`${percentFee}%`);
                if (perTxFee > 0) feeComponents.push(`$${perTxFee.toFixed(2)}/tx`);
                const feeLabel = feeComponents.length > 0 ? `Fees` : 'Fees';
                
                const tableHeaders = ['Week', 'Sales', 'Gross', feeLabel, 'Refunds', 'Ref Fees', 'CBs', 'CB Fees', 'Net'];
                const headerRow = ws.getRow(row);
                tableHeaders.forEach((header, i) => {
                    const cell = headerRow.getCell(i + 2); // Start at column B
                    cell.value = header;
                    cell.font = { bold: true, size: 9, color: { argb: 'FF' + colors.white } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.secondary } };
                    cell.alignment = { horizontal: i === 0 ? 'left' : 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin', color: { argb: 'FF' + colors.secondary } },
                        bottom: { style: 'thin', color: { argb: 'FF' + colors.secondary } }
                    };
                });
                setRowHeight(row, 22);
                row++;
                
                // Table data rows
                let totalSales = 0, totalGross = 0, totalFees = 0;
                let totalRefundsCount = 0, totalRefundFees = 0;
                let totalCBsCount = 0, totalCBFees = 0, totalNet = 0;
                let isAlt = false;
                
                sortedWeeks.forEach(weekKey => {
                    const week = weeklyData[weekKey];
                    const weekRange = formatWeekRange(week.weekStart, week.weekEnd);
                    
                    const processingFeeAmount = week.grossPayments * (percentFee / 100);
                    const allTxCount = week.count + week.refundCount + week.chargebackCount;
                    const transactionFees = allTxCount * perTxFee;
                    const combinedFees = processingFeeAmount + transactionFees;
                    const weekRefundFees = week.refundCount * refundFee;
                    const weekCBFees = week.chargebackCount * cbFee;
                    const netAmount = week.grossPayments - combinedFees - weekRefundFees - weekCBFees;
                    
                    totalSales += week.count;
                    totalGross += week.grossPayments;
                    totalFees += combinedFees;
                    totalRefundsCount += week.refundCount;
                    totalRefundFees += weekRefundFees;
                    totalCBsCount += week.chargebackCount;
                    totalCBFees += weekCBFees;
                    totalNet += netAmount;
                    
                    const dataRow = ws.getRow(row);
                    const rowData = [weekRange, week.count, week.grossPayments, combinedFees, week.refundCount, weekRefundFees, week.chargebackCount, weekCBFees, netAmount];
                    
                    rowData.forEach((val, i) => {
                        const cell = dataRow.getCell(i + 2);
                        cell.value = val;
                        if (i >= 2 && i !== 4 && i !== 6) cell.numFmt = '"$"#,##0.00';
                        cell.font = { size: 10, color: { argb: 'FF' + colors.secondary } };
                        cell.alignment = { horizontal: i === 0 ? 'left' : 'center', vertical: 'middle' };
                        if (isAlt) {
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.light } };
                        }
                        cell.border = { bottom: { style: 'hair', color: { argb: 'FF' + colors.border } } };
                    });
                    
                    setRowHeight(row, 20);
                    isAlt = !isAlt;
                    row++;
                });
                
                // Subtotal row
                const subtotalRowData = ['TOTAL', totalSales, totalGross, totalFees, totalRefundsCount, totalRefundFees, totalCBsCount, totalCBFees, totalNet];
                const subRow = ws.getRow(row);
                subtotalRowData.forEach((val, i) => {
                    const cell = subRow.getCell(i + 2);
                    cell.value = val;
                    cell.font = { bold: true, size: 10, color: { argb: 'FF' + colors.primary } };
                    if (i >= 2 && i !== 4 && i !== 6) cell.numFmt = '"$"#,##0.00';
                    cell.alignment = { horizontal: i === 0 ? 'left' : 'center', vertical: 'middle' };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.border } };
                    cell.border = {
                        top: { style: 'medium', color: { argb: 'FF' + colors.secondary } },
                        bottom: { style: 'medium', color: { argb: 'FF' + colors.secondary } }
                    };
                });
                setRowHeight(row, 24);
                row++;
                
                // Spacer
                setRowHeight(row, 20);
                row++;
                
                // === FEE BREAKDOWN ===
                ws.mergeCells(`B${row}:E${row}`);
                const feeHeader = ws.getCell(`B${row}`);
                feeHeader.value = 'FEE DETAILS';
                feeHeader.font = { bold: true, size: 11, color: { argb: 'FF' + colors.secondary } };
                feeHeader.border = { bottom: { style: 'medium', color: { argb: 'FF' + colors.accent } } };
                
                // Settlement calc header
                ws.mergeCells(`G${row}:I${row}`);
                const calcHeader = ws.getCell(`G${row}`);
                calcHeader.value = 'SETTLEMENT CALCULATION';
                calcHeader.font = { bold: true, size: 11, color: { argb: 'FF' + colors.secondary } };
                calcHeader.border = { bottom: { style: 'medium', color: { argb: 'FF' + colors.accent } } };
                setRowHeight(row, 24);
                row++;
                
                setRowHeight(row, 8);
                row++;
                
                // Fee items and calculation side by side
                const feeItems = [];
                if (storedProcessingFee > 0) feeItems.push([`Processing (${percentFee}%)`, -storedProcessingFee]);
                if (storedTxFees > 0) feeItems.push([`Per-Transaction ($${perTxFee.toFixed(2)} × ${totalTxCount})`, -storedTxFees]);
                if (storedRefundFees > 0) feeItems.push([`Refund Fees ($${refundFee.toFixed(2)} × ${refundCountTotal})`, -storedRefundFees]);
                if (storedCBFees > 0) feeItems.push([`Chargeback Fees ($${cbFee.toFixed(2)} × ${chargebackCountTotal})`, -storedCBFees]);
                if (storedFeeCredit > 0) feeItems.push(['Processing Credit', storedFeeCredit]);
                
                const calcItems = [
                    ['Gross Sales', parseFloat(report.gross_amount || 0)],
                    ['Less: Fees', -storedTotalFees]
                ];
                if (adjustmentsTotal > 0) calcItems.push(['Less: Adjustments', -adjustmentsTotal]);
                if (manualAdjustment !== 0) calcItems.push(['Manual Adjustment', manualAdjustment]);
                
                const maxRows = Math.max(feeItems.length, calcItems.length);
                
                for (let i = 0; i < maxRows; i++) {
                    // Fee column
                    if (feeItems[i]) {
                        ws.getCell(`B${row}`).value = feeItems[i][0];
                        ws.getCell(`B${row}`).font = { size: 10, color: { argb: 'FF' + colors.muted } };
                        ws.getCell(`E${row}`).value = feeItems[i][1];
                        ws.getCell(`E${row}`).numFmt = '"$"#,##0.00;"-$"#,##0.00';
                        ws.getCell(`E${row}`).font = { size: 10, color: { argb: feeItems[i][1] >= 0 ? 'FF' + colors.success : 'FF' + colors.danger } };
                        ws.getCell(`E${row}`).alignment = { horizontal: 'right' };
                    }
                    
                    // Calc column
                    if (calcItems[i]) {
                        ws.getCell(`G${row}`).value = calcItems[i][0];
                        ws.getCell(`G${row}`).font = { size: 10, color: { argb: 'FF' + colors.secondary } };
                        ws.getCell(`I${row}`).value = calcItems[i][1];
                        ws.getCell(`I${row}`).numFmt = '"$"#,##0.00;"-$"#,##0.00';
                        ws.getCell(`I${row}`).font = { size: 10, color: { argb: calcItems[i][1] >= 0 ? 'FF' + colors.secondary : 'FF' + colors.danger } };
                        ws.getCell(`I${row}`).alignment = { horizontal: 'right' };
                    }
                    
                    setRowHeight(row, 18);
                    row++;
                }
                
                // Fee total
                ws.getCell(`B${row}`).value = 'Total Fees';
                ws.getCell(`B${row}`).font = { bold: true, size: 10, color: { argb: 'FF' + colors.primary } };
                ws.getCell(`E${row}`).value = -storedTotalFees;
                ws.getCell(`E${row}`).numFmt = '"-$"#,##0.00';
                ws.getCell(`E${row}`).font = { bold: true, size: 10, color: { argb: 'FF' + colors.danger } };
                ws.getCell(`E${row}`).alignment = { horizontal: 'right' };
                ws.getCell(`E${row}`).border = { top: { style: 'thin', color: { argb: 'FF' + colors.border } } };
                
                // Net Payout
                ws.getCell(`G${row}`).value = 'NET PAYOUT';
                ws.getCell(`G${row}`).font = { bold: true, size: 11, color: { argb: 'FF' + colors.success } };
                ws.mergeCells(`H${row}:I${row}`);
                ws.getCell(`H${row}`).value = merchantPayout;
                ws.getCell(`H${row}`).numFmt = '"$"#,##0.00';
                ws.getCell(`H${row}`).font = { bold: true, size: 14, color: { argb: 'FF' + colors.white } };
                ws.getCell(`H${row}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.success } };
                ws.getCell(`H${row}`).alignment = { horizontal: 'center', vertical: 'middle' };
                ws.getCell(`H${row}`).border = {
                    top: { style: 'medium', color: { argb: 'FF' + colors.successDark } },
                    bottom: { style: 'medium', color: { argb: 'FF' + colors.successDark } },
                    left: { style: 'medium', color: { argb: 'FF' + colors.successDark } },
                    right: { style: 'medium', color: { argb: 'FF' + colors.successDark } }
                };
                setRowHeight(row, 28);
                row++;
                
                // Spacer
                setRowHeight(row, 20);
                row++;
                
                // === FOOTER ===
                ws.mergeCells(`B${row}:I${row}`);
                const footerCell = ws.getCell(`B${row}`);
                footerCell.value = `Generated on ${generatedDate} • Status: ${report.status.toUpperCase()}`;
                footerCell.font = { size: 9, color: { argb: 'FF' + colors.muted }, italic: true };
                footerCell.alignment = { horizontal: 'center' };
                setRowHeight(row, 20);
                row++;
                
                // Bottom accent bar
                ws.mergeCells(`A${row}:J${row}`);
                ws.getCell(`A${row}`).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + colors.accent } };
                setRowHeight(row, 6);
                
                // Generate and download
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${report.site_name}_${report.report_number}.xlsx`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);
                
            } catch (e) {
                console.error('Excel download error:', e);
                alert('Error generating Excel file: ' + e.message);
            }
        }
        
        // Helper: Get start of week (Sunday)
        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            d.setDate(d.getDate() - day);
            d.setHours(0, 0, 0, 0);
            return d;
        }
        
        // Helper: Get end of week (Saturday)
        function getWeekEnd(weekStart) {
            const d = new Date(weekStart);
            d.setDate(d.getDate() + 6);
            return d;
        }
        
        // Helper: Format week range like "Sep 01 - 07, 2025" or "Sep 29 - Oct 05, 2025"
        function formatWeekRange(start, end) {
            const startMonth = start.toLocaleDateString('en-US', { month: 'short' });
            const endMonth = end.toLocaleDateString('en-US', { month: 'short' });
            const startDay = String(start.getDate()).padStart(2, '0');
            const endDay = String(end.getDate()).padStart(2, '0');
            const year = end.getFullYear();
            
            if (startMonth === endMonth) {
                return `${startMonth} ${startDay} - ${endDay}, ${year}`;
            } else {
                return `${startMonth} ${startDay} - ${endMonth} ${endDay}, ${year}`;
            }
        }

        function formatCurrency(a) { return new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD' }).format(a || 0); }
        
        // Date Range Functions
        function initDateRangeDropdown() {
            const dateOptions = [
                { value: '7', label: 'Last 7 Days' },
                { value: '30', label: 'Last 30 Days' },
                { value: '90', label: 'Last 90 Days' },
                { value: '365', label: 'Last Year' },
                { value: 'all', label: 'All Time' },
                { value: 'custom', label: 'Custom Range' }
            ];
            
            populateDateDropdown('dateRangeTrigger', 'dateRangeMenu', 'dateRange', dateOptions, handleDateRangeChange);
        }
        
        function populateDateDropdown(triggerId, menuId, hiddenId, options, onChange) {
            const trigger = document.getElementById(triggerId);
            const menu = document.getElementById(menuId);
            const hidden = document.getElementById(hiddenId);
            
            // Populate options
            menu.innerHTML = options.map(opt => 
                `<div class="custom-dropdown-option${opt.value === hidden.value ? ' selected' : ''}" data-value="${opt.value}">${opt.label}</div>`
            ).join('');
            
            // Toggle menu
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                document.querySelectorAll('.custom-dropdown-menu').forEach(m => {
                    if (m !== menu) m.classList.remove('active');
                });
                menu.classList.toggle('active');
            });
            
            // Handle selection
            menu.querySelectorAll('.custom-dropdown-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const value = opt.dataset.value;
                    const label = opt.textContent;
                    
                    menu.querySelectorAll('.custom-dropdown-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    
                    trigger.textContent = label;
                    hidden.value = value;
                    menu.classList.remove('active');
                    
                    // Handle custom date range
                    const customContainer = document.getElementById('customDateContainer');
                    if (value === 'custom') {
                        customContainer.classList.add('active');
                    } else {
                        customContainer.classList.remove('active');
                        if (onChange) onChange();
                    }
                });
            });
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', () => {
            document.querySelectorAll('.custom-dropdown-menu').forEach(m => m.classList.remove('active'));
        });
        
        function initDatePickers() {
            const today = new Date().toISOString().split('T')[0];
            const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            document.getElementById('startDateValue').value = thirtyDaysAgo;
            document.getElementById('endDateValue').value = today;
            document.getElementById('startDateValue').max = today;
            document.getElementById('endDateValue').max = today;
        }
        
        function handleDateRangeChange() {
            currentDateRange = document.getElementById('dateRange').value;
            customStartDate = null;
            customEndDate = null;
            selectedTransactions.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            applyFilter();
            updateSelectionSummary();
        }
        
        window.cancelCustomDate = function() {
            document.getElementById('customDateContainer').classList.remove('active');
            document.getElementById('dateRange').value = 'all';
            document.getElementById('dateRangeTrigger').textContent = 'All Time';
            currentDateRange = 'all';
            customStartDate = null;
            customEndDate = null;
            applyFilter();
        };
        
        window.applyCustomDate = function() {
            const startVal = document.getElementById('startDateValue').value;
            const endVal = document.getElementById('endDateValue').value;
            
            if (!startVal || !endVal) {
                alert('Please select both start and end dates');
                return;
            }
            
            if (new Date(startVal) > new Date(endVal)) {
                alert('Start date must be before end date');
                return;
            }
            
            currentDateRange = 'custom';
            customStartDate = startVal;
            customEndDate = endVal;
            
            // Update trigger to show custom range
            const trigger = document.getElementById('dateRangeTrigger');
            const startDate = new Date(startVal);
            const endDate = new Date(endVal);
            trigger.textContent = `${startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${endDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}`;
            
            document.getElementById('customDateContainer').classList.remove('active');
            selectedTransactions.clear();
            document.getElementById('selectAllCheckbox').checked = false;
            applyFilter();
            updateSelectionSummary();
        };
        
        function getDateFilterRange() {
            const now = new Date();
            let startDate = null, endDate = null;
            
            if (currentDateRange === 'custom' && customStartDate && customEndDate) {
                const [startYear, startMonth, startDay] = customStartDate.split('-').map(Number);
                const [endYear, endMonth, endDay] = customEndDate.split('-').map(Number);
                startDate = new Date(startYear, startMonth - 1, startDay, 0, 0, 0, 0);
                endDate = new Date(endYear, endMonth - 1, endDay, 23, 59, 59, 999);
            } else if (currentDateRange === 'all') {
                startDate = null;
                endDate = null;
            } else {
                const days = parseInt(currentDateRange);
                startDate = new Date(now);
                startDate.setDate(startDate.getDate() - days);
                startDate.setHours(0, 0, 0, 0);
                endDate = new Date(now);
                endDate.setHours(23, 59, 59, 999);
            }
            
            return { startDate, endDate };
        }
        
        document.addEventListener('DOMContentLoaded', init);
        window.initPage = init;
    </script>
</body>
</html>

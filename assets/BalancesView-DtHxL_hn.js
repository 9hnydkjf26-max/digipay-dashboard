import{_ as J,r as m,i as M,j as K,o as Q,c as o,e as t,f as y,g as v,t as n,n as w,k as W,F as b,d as H,y as C,G as P,m as X,p as Y,h as l}from"./index-6BX6ZuWm.js";import{u as x}from"./useFormatting-CP8YxVhJ.js";import{C as ee}from"./CustomDropdown-CLjAania.js";const te={class:"reports-page balances"},ae={class:"reports-main"},se={class:"reports-topbar"},re={class:"reports-topbar-right"},oe=["disabled"],ne={key:0,viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2",width:"16",height:"16"},le={key:1,class:"btn-spinner"},ie={class:"reports-stats-row"},ce={class:"reports-stat-box"},ue={class:"reports-stat-box"},de={class:"reports-stat-value"},pe={class:"reports-stat-box"},ve={class:"reports-stat-value"},_e={class:"reports-stat-box"},he={class:"reports-stat-value"},me={class:"balances-filters"},fe={class:"filter-group"},ye={class:"balances-content-grid"},be={class:"report-panel balance-panel"},ge={class:"report-panel-header"},ke={class:"report-panel-subtitle"},we={key:0,class:"report-empty"},Ce={key:1,class:"report-loading"},Ae={key:2,class:"balance-content"},Te={class:"balance-hero"},Be={class:"balance-hero-label"},Me={class:"balance-hero-amount"},Se={class:"balance-hero-breakdown"},Ne={class:"balance-available"},Ve={class:"balance-pending"},De={key:0,class:"currency-list"},Ee={class:"currency-code"},Le={class:"currency-amount"},Fe={class:"report-panel transactions-panel"},je={class:"report-panel-header"},qe={class:"report-panel-subtitle"},ze={key:0,class:"report-empty"},He={key:1,class:"report-loading"},Pe={key:2,class:"report-empty"},Ue={class:"report-empty-title"},Ie={class:"report-empty-text"},Re={key:3,class:"report-table-container"},Oe={class:"report-table"},Ge={class:"cell-date"},Ze={class:"date"},$e={class:"time"},Je={class:"txn-description"},Ke={class:"txn-desc-text"},Qe={key:0,class:"txn-ref"},We={key:1,class:"txn-failure"},Xe={class:"align-right"},Ye={key:0,class:"load-more-container"},xe=["disabled"],et={key:0,class:"btn-spinner"},tt=25,at={__name:"BalancesView",setup(st){const{supabase:A}=X(),{error:S}=Y(),{formatCurrency:f}=x(),g=m(!1),_=m(!1),N=m(!0),d=m(""),T=m([]),i=m(null),p=m([]),V=m(!1),D=m(0),U=M(()=>{const a=T.value.filter(s=>s.payment_provider==="airwallex"),e=T.value.filter(s=>s.payment_provider==="stripe"),c=[{value:"",label:"Select an account..."}];return a.length>0&&(c.push({value:"",label:"── Airwallex ──",disabled:!0}),a.forEach(s=>{c.push({value:s.account_id,label:s.account_name||s.account_id})})),e.length>0&&(c.push({value:"",label:"── Stripe ──",disabled:!0}),e.forEach(s=>{c.push({value:s.account_id,label:s.account_name||s.account_id})})),c}),h=M(()=>d.value?T.value.find(a=>a.account_id===d.value):null),B=M(()=>{if(!i.value)return{available:"-",pending:"-",total:"-",txnCount:p.value.length};const a=i.value.primary_currency||"CAD",e=i.value.available_balance||0,c=i.value.pending_balance||0,s=i.value.total_balance||0;return{available:f(e,a),pending:f(c,a),total:f(s,a),txnCount:p.value.length}}),L=M(()=>{var a;return(a=i.value)!=null&&a.balances_by_currency?i.value.balances_by_currency.filter(e=>e.total>0||e.available>0||e.pending>0).sort((e,c)=>c.total-e.total):[]});async function I(){N.value=!0;try{const{data:a,error:e}=await A.from("payment_accounts").select("account_id, account_name, payment_provider, is_active").in("payment_provider",["airwallex","stripe"]).eq("is_active",!0).order("payment_provider").order("account_name");if(e)throw e;T.value=a||[]}catch(a){console.error("Error loading accounts:",a),S("Failed to load accounts")}finally{N.value=!1}}async function F(){var a,e;if(!d.value||!h.value){i.value=null;return}g.value=!0;try{const s=h.value.payment_provider==="stripe"?"stripe-balance-checker":"airwallex-balance-checker",{data:u,error:k}=await A.functions.invoke(s,{body:{account_id:d.value}});if(k)throw k;if(((a=u==null?void 0:u.balances)==null?void 0:a.length)>0)i.value=u.balances[0];else if(((e=u==null?void 0:u.errors)==null?void 0:e.length)>0)throw new Error(u.errors[0].error)}catch(c){console.error("Error fetching balance:",c),S("Failed to fetch balance: "+c.message)}finally{g.value=!1}}async function E(a=0,e=!1){if(!d.value||!h.value){p.value=[];return}const c=h.value.payment_provider;_.value=!0;try{if(c==="stripe"){const{data:s,error:u}=await A.functions.invoke("stripe-recent-transactions",{body:{account_id:d.value,limit:10}});if(u)throw u;if(s!=null&&s.success)p.value=s.transactions||[],V.value=!1;else if(s!=null&&s.error)throw new Error(s.error)}else{const{data:s,error:u}=await A.functions.invoke("airwallex-wallet-transactions",{body:{account_id:d.value,page_num:a,page_size:tt}});if(u)throw u;if(s!=null&&s.success)e?p.value=[...p.value,...s.transactions||[]]:p.value=s.transactions||[],V.value=s.has_more||!1,D.value=a;else if(s!=null&&s.error)throw new Error(s.error)}}catch(s){console.error("Error fetching transactions:",s),S("Failed to fetch transactions: "+s.message)}finally{_.value=!1}}async function R(){await E(D.value+1,!0)}async function O(){d.value&&(i.value=null,p.value=[],await Promise.all([F(),E(0)]))}function j(a){if(!a)return{date:"-",time:""};const e=new Date(a);return isNaN(e.getTime())?{date:"-",time:""}:{date:e.toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),time:e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}}function q(a){return a.created_at||a.createdAt||a.settledAt||a.posted_at||null}function G(a){return a.payment_method_type?{card:"Card Payment",bank_transfer:"Bank Transfer",us_bank_account:"Bank Account",sepa_debit:"SEPA Debit",ideal:"iDEAL",sofort:"Sofort"}[a.payment_method_type]||a.payment_method_type.replace(/_/g," ").replace(/\b\w/g,s=>s.toUpperCase()):(a.transactionType||a.transaction_type||a.type||"unknown").replace(/_/g," ").replace(/([A-Z])/g," $1").trim().replace(/\b\w/g,c=>c.toUpperCase())}function Z(a){if(a.failure_code||a.status==="failed"||a.status==="requires_payment_method")return"failed";if(a.payment_method_type)return a.status==="succeeded"?"credit":a.status==="processing"||a.status==="requires_action"?"pending":"default";const e=(a.transactionType||a.transaction_type||a.type||"").toLowerCase();return e.includes("deposit")||e.includes("receive")||e.includes("payment")||e.includes("settlement")?"credit":e.includes("withdraw")||e.includes("payout")||e.includes("transfer")?"debit":e.includes("conversion")||e.includes("fx")?"conversion":e.includes("fee")?"fee":e.includes("refund")?"refund":"default"}function $(a){const e=(a||"").toLowerCase();return e==="completed"||e==="succeeded"||e==="success"?"complete":e==="pending"||e==="processing"||e==="requires_confirmation"||e==="requires_action"?"pending":e==="failed"||e==="cancelled"||e==="rejected"||e==="requires_payment_method"||e==="canceled"?"failed":"default"}return K(d,async a=>{a?(i.value=null,p.value=[],D.value=0,await Promise.all([F(),E(0)])):(i.value=null,p.value=[])}),Q(()=>{I()}),(a,e)=>{var c,s,u,k,z;return l(),o("div",te,[e[20]||(e[20]=t("div",{class:"reports-bg"},[t("div",{class:"reports-grid"}),t("div",{class:"reports-glow reports-glow-1"}),t("div",{class:"reports-glow reports-glow-2"})],-1)),t("div",ae,[t("header",se,[e[2]||(e[2]=t("div",{class:"reports-topbar-left"},[t("div",{class:"reports-page-title"},[t("span",{class:"reports-breadcrumb"},"Reports"),t("h1",null,"Balances")])],-1)),t("div",re,[d.value?(l(),o("button",{key:0,class:"reports-btn reports-btn-secondary",onClick:O,disabled:g.value||_.value},[!g.value&&!_.value?(l(),o("svg",ne,[...e[1]||(e[1]=[t("path",{d:"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15","stroke-linecap":"round","stroke-linejoin":"round"},null,-1)])])):(l(),o("span",le)),v(" "+n(g.value||_.value?"Refreshing...":"Refresh"),1)],8,oe)):y("",!0)])]),t("div",ie,[t("div",ce,[t("span",{class:w(["reports-stat-value",{"reports-stat-success":i.value}])},n(B.value.available),3),e[3]||(e[3]=t("span",{class:"reports-stat-label"},"Available",-1))]),t("div",ue,[t("span",de,n(B.value.pending),1),e[4]||(e[4]=t("span",{class:"reports-stat-label"},"Pending",-1))]),t("div",pe,[t("span",ve,n(B.value.total),1),e[5]||(e[5]=t("span",{class:"reports-stat-label"},"Total Balance",-1))]),t("div",_e,[t("span",he,n(B.value.txnCount),1),e[6]||(e[6]=t("span",{class:"reports-stat-label"},"Transactions",-1))])]),t("div",me,[t("div",fe,[e[7]||(e[7]=t("label",{class:"filter-label"},"Airwallex Account",-1)),W(ee,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=r=>d.value=r),options:U.value,disabled:N.value,placeholder:"Select an account...",class:"balances-account-select"},null,8,["modelValue","options","disabled"])]),i.value?(l(),o("span",{key:0,class:w(["provider-badge",(c=h.value)==null?void 0:c.payment_provider])},[e[8]||(e[8]=t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2",width:"14",height:"14"},[t("path",{d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),v(" "+n(((s=h.value)==null?void 0:s.payment_provider)==="stripe"?"Stripe":"Airwallex"),1)],2)):y("",!0)]),t("div",ye,[t("div",be,[t("div",ge,[t("div",null,[e[9]||(e[9]=t("div",{class:"report-panel-title"},"Account Balance",-1)),t("div",ke,[i.value?(l(),o(b,{key:0},[v(n((u=h.value)==null?void 0:u.account_name),1)],64)):d.value?(l(),o(b,{key:1},[v(" Loading... ")],64)):(l(),o(b,{key:2},[v(" No account selected ")],64))])])]),d.value?g.value?(l(),o("div",Ce,[...e[11]||(e[11]=[t("div",{class:"report-spinner"},null,-1)])])):i.value?(l(),o("div",Ae,[t("div",Te,[t("div",Be,n(i.value.primary_currency)+" Balance",1),t("div",Me,n(C(f)(i.value.total_balance,i.value.primary_currency)),1),t("div",Se,[t("span",Ne,[e[12]||(e[12]=t("span",{class:"dot available"},null,-1)),v(" "+n(C(f)(i.value.available_balance,i.value.primary_currency))+" available ",1)]),t("span",Ve,[e[13]||(e[13]=t("span",{class:"dot pending"},null,-1)),v(" "+n(C(f)(i.value.pending_balance,i.value.primary_currency))+" pending ",1)])])]),L.value.length>1?(l(),o("div",De,[(l(!0),o(b,null,P(L.value,r=>(l(),o("div",{key:r.currency,class:"currency-item"},[t("span",Ee,n(r.currency),1),t("span",Le,n(C(f)(r.total,r.currency)),1)]))),128))])):y("",!0)])):y("",!0):(l(),o("div",we,[...e[10]||(e[10]=[H('<div class="report-empty-icon" data-v-58be8ace><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-v-58be8ace><path d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" stroke-linecap="round" stroke-linejoin="round" data-v-58be8ace></path></svg></div><div class="report-empty-title" data-v-58be8ace>Select an Account</div><div class="report-empty-text" data-v-58be8ace>Choose an account above</div>',3)])]))]),t("div",Fe,[t("div",je,[t("div",null,[e[14]||(e[14]=t("div",{class:"report-panel-title"},"Recent Transactions",-1)),t("div",qe,[d.value?(l(),o(b,{key:0},[v(n(p.value.length)+" transaction"+n(p.value.length!==1?"s":"")+" loaded ",1)],64)):(l(),o(b,{key:1},[v(" No account selected ")],64))])])]),d.value?_.value&&p.value.length===0?(l(),o("div",He,[...e[16]||(e[16]=[t("div",{class:"report-spinner"},null,-1),t("div",{style:{color:"var(--text-tertiary)"}},"Loading transactions...",-1)])])):p.value.length===0?(l(),o("div",Pe,[e[17]||(e[17]=t("div",{class:"report-empty-icon"},[t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"1.5"},[t("path",{d:"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2","stroke-linecap":"round","stroke-linejoin":"round"})])],-1)),t("div",Ue,n(((k=h.value)==null?void 0:k.payment_provider)==="stripe"?"Balance Only":"No Transactions"),1),t("div",Ie,n(((z=h.value)==null?void 0:z.payment_provider)==="stripe"?"Transaction history is not available for Stripe accounts":"No recent wallet transactions found"),1)])):(l(),o("div",Re,[t("table",Oe,[e[19]||(e[19]=t("thead",null,[t("tr",null,[t("th",null,"Date"),t("th",null,"Type"),t("th",null,"Description"),t("th",{class:"align-right"},"Amount"),t("th",null,"Status")])],-1)),t("tbody",null,[(l(!0),o(b,null,P(p.value,r=>(l(),o("tr",{key:r.id||r.transaction_id},[t("td",null,[t("div",Ge,[t("span",Ze,n(j(q(r)).date),1),t("span",$e,n(j(q(r)).time),1)])]),t("td",null,[t("span",{class:w(["txn-type-badge",Z(r)])},n(G(r)),3)]),t("td",null,[t("div",Je,[t("span",Ke,n(r.description||r.customer_email||r.customer_name||r.reason||"-"),1),r.sourceId||r.source_id||r.id?(l(),o("span",Qe,n(r.sourceId||r.source_id||r.id),1)):y("",!0),r.failure_message?(l(),o("span",We,[e[18]||(e[18]=t("svg",{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor","stroke-width":"2",width:"12",height:"12"},[t("path",{d:"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z","stroke-linecap":"round","stroke-linejoin":"round"})],-1)),v(" "+n(r.failure_message),1)])):y("",!0)])]),t("td",Xe,[t("span",{class:w(["report-amount",{positive:parseFloat(r.amount)>0&&!r.failure_code,negative:parseFloat(r.amount)<0||r.failure_code}])},n(C(f)(Math.abs(parseFloat(r.amount)),r.currency)),3)]),t("td",null,[t("span",{class:w(["report-status",$(r.status)])},n(r.status||"N/A"),3)])]))),128))])]),V.value?(l(),o("div",Ye,[t("button",{class:"reports-btn reports-btn-secondary load-more-btn",onClick:R,disabled:_.value},[_.value?(l(),o("span",et)):y("",!0),v(" "+n(_.value?"Loading...":"Load More Transactions"),1)],8,xe)])):y("",!0)])):(l(),o("div",ze,[...e[15]||(e[15]=[H('<div class="report-empty-icon" data-v-58be8ace><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" data-v-58be8ace><path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" stroke-linecap="round" stroke-linejoin="round" data-v-58be8ace></path></svg></div><div class="report-empty-title" data-v-58be8ace>No Transactions</div><div class="report-empty-text" data-v-58be8ace>Select an account to view transactions</div>',3)])]))])])])])}}},lt=J(at,[["__scopeId","data-v-58be8ace"]]);export{lt as default};

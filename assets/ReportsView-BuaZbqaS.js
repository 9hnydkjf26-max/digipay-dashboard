import{_ as ne,r as u,i as v,o as oe,j as ue,c as I,e as s,w as y,n as C,k as m,f as B,v as F,g as re,t as A,l as T,m as ce,p as ie,h as L}from"./index-CX6fTkOy.js";import{S as x}from"./StatsGrid-Bq0ZNdfH.js";import{C as q}from"./CustomDropdown-LrCUM5C5.js";import{D as N}from"./DataTable-DfAhrklb.js";const de={class:"main-content"},ve={class:"container"},me={class:"tabs"},fe={class:"card"},be={class:"card-body"},pe={class:"filters-grid"},ge={class:"form-group"},ye={key:0,class:"custom-date-picker"},_e={class:"date-inputs"},De={class:"form-group"},he={class:"form-group"},ke={class:"form-group"},Re=["disabled"],we={key:0,class:"loading-spinner"},Se={class:"card"},Ce={class:"card-body"},Ae={class:"text-muted mt-2"},Te={__name:"ReportsView",setup(Ve){const{supabase:k}=ce(),{error:M}=ie(),o=u(!1),n=u("overview"),p=u("30"),i=u(""),R=u(""),w=u(""),S=u(!1),V=u([]),g=u([]),d=u([]),_=u([]),E=v(()=>{const t={};return V.value.forEach(e=>{t[e.account_id]=e.account_name||e.account_id}),t}),Q=[{value:"7",label:"Last 7 Days"},{value:"30",label:"Last 30 Days"},{value:"90",label:"Last 90 Days"},{value:"365",label:"Last Year"},{value:"all",label:"All Time"},{value:"custom",label:"Custom Range"}],j=v(()=>[{value:"",label:"All Accounts"},...V.value.map(t=>({value:t.account_id,label:`${t.account_name||t.account_id} [${t.payment_provider==="airwallex"?"Airwallex":"Stripe"}]`}))]),G=v(()=>{const t=g.value.length,a=g.value.filter(l=>l.status==="succeeded").reduce((l,h)=>l+(h.amount||0),0)/100,f=d.value.reduce((l,h)=>l+(h.amount||0),0)/100,c=t>0?(d.value.length/t*100).toFixed(1):0;return[{label:"Total Charges",value:t.toLocaleString()},{label:"Total Revenue",value:r(a)},{label:"Total Refunds",value:r(f)},{label:"Refund Rate",value:`${c}%`}]}),P=v(()=>{const t=d.value.length,e=d.value.reduce((f,c)=>f+(c.amount||0),0)/100,a=t>0?e/t:0;return[{label:"Refunds Issued",value:t.toLocaleString()},{label:"Refund Amount",value:r(e)},{label:"Avg Refund",value:r(a)}]}),z=v(()=>{const t=_.value.length,e=_.value.reduce((c,l)=>c+(l.amount||0),0)/100,a=g.value.reduce((c,l)=>c+(l.amount||0),0)/100,f=a>0?(e/a*100).toFixed(2):0;return[{label:"Total Disputes",value:t.toLocaleString()},{label:"Dispute Amount",value:r(e)},{label:"Total Volume",value:r(a)},{label:"Dispute Rate",value:`${f}%`}]}),Y=v(()=>{const t={};return g.value.forEach(e=>{const a=e.account_id||"unknown";t[a]||(t[a]={account:E.value[a]||a,charges:0,revenue:0,refunds:0}),t[a].charges++,e.status==="succeeded"&&(t[a].revenue+=(e.amount||0)/100)}),d.value.forEach(e=>{const a=e.account_id||"unknown";t[a]&&t[a].refunds++}),Object.values(t).map(e=>({...e,refundRate:e.charges>0?`${(e.refunds/e.charges*100).toFixed(1)}%`:"0%",avgTransaction:e.charges>0?r(e.revenue/e.charges):"$0.00",revenue:r(e.revenue)}))}),H=[{key:"account",label:"Account",sortable:!0},{key:"charges",label:"Charges",sortable:!0},{key:"revenue",label:"Revenue",sortable:!0},{key:"refunds",label:"Refunds",sortable:!0},{key:"refundRate",label:"Refund Rate",sortable:!0},{key:"avgTransaction",label:"Avg Transaction",sortable:!0}],J=[{key:"id",label:"Refund ID",sortable:!0},{key:"account",label:"Account",sortable:!0},{key:"amount",label:"Amount",sortable:!0},{key:"reason",label:"Reason",sortable:!0},{key:"date",label:"Date",sortable:!0}],K=[{key:"id",label:"Dispute ID",sortable:!0},{key:"account",label:"Account",sortable:!0},{key:"amount",label:"Amount",sortable:!0},{key:"reason",label:"Reason",sortable:!0},{key:"status",label:"Status",sortable:!0},{key:"date",label:"Date",sortable:!0}],W=v(()=>d.value.map(t=>{var e,a;return{id:((e=t.stripe_refund_id)==null?void 0:e.substring(0,12))||((a=t.id)==null?void 0:a.substring(0,12)),account:E.value[t.account_id]||t.account_id,amount:r((t.amount||0)/100),reason:t.reason||"N/A",date:$(t.created_at)}})),X=v(()=>_.value.map(t=>{var e,a;return{id:((e=t.stripe_dispute_id)==null?void 0:e.substring(0,12))||((a=t.id)==null?void 0:a.substring(0,12)),account:E.value[t.account_id]||t.account_id,amount:r((t.amount||0)/100),reason:t.reason||"N/A",status:t.status||"Unknown",date:$(t.created_at)}}));function r(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t)}function $(t){return t?new Date(t).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"}):"N/A"}function Z(){const t=new Date;let e=null;if(p.value==="custom")return{start:R.value,end:w.value};if(p.value!=="all"){const a=parseInt(p.value);e=new Date(t.getTime()-a*24*60*60*1e3)}return{start:e?e.toISOString():null,end:t.toISOString()}}async function ee(){try{const{data:t,error:e}=await k.from("payment_accounts").select("account_id, account_name, payment_provider").eq("is_active",!0).order("account_name");if(e)throw e;V.value=t||[]}catch(t){console.error("Error loading accounts:",t)}}async function D(){o.value=!0;try{const{start:t,end:e}=Z();let a=k.from("stripe_charges").select("*").order("created_at",{ascending:!1});t&&(a=a.gte("created_at",t)),e&&(a=a.lte("created_at",e)),i.value&&(a=a.eq("account_id",i.value));const{data:f,error:c}=await a;if(c)throw c;g.value=f||[];let l=k.from("stripe_refunds").select("*").order("created_at",{ascending:!1});t&&(l=l.gte("created_at",t)),e&&(l=l.lte("created_at",e)),i.value&&(l=l.eq("account_id",i.value));const{data:h,error:O}=await l;if(O)throw O;d.value=h||[];let b=k.from("stripe_disputes").select("*").order("created_at",{ascending:!1});t&&(b=b.gte("created_at",t)),e&&(b=b.lte("created_at",e)),i.value&&(b=b.eq("account_id",i.value));const{data:le,error:U}=await b;if(U)throw U;_.value=le||[]}catch(t){console.error("Error loading reports:",t),M("Error loading reports. Please try again.")}finally{o.value=!1}}function te(t){p.value=t,S.value=t==="custom",t!=="custom"&&D()}function ae(){S.value=!1,D()}function se(){S.value=!1,p.value="30"}return oe(()=>{const t=new Date().toISOString().split("T")[0],e=new Date(Date.now()-30*24*60*60*1e3).toISOString().split("T")[0];R.value=e,w.value=t,ee(),D()}),ue(i,()=>{D()}),(t,e)=>(L(),I("div",de,[s("div",ve,[e[12]||(e[12]=s("h1",{class:"page-title"},"Reports",-1)),e[13]||(e[13]=s("p",{class:"page-subtitle"},"Transaction analytics and insights",-1)),s("div",me,[s("button",{class:C(["tab",{active:n.value==="overview"}]),onClick:e[0]||(e[0]=a=>n.value="overview")}," Overview ",2),s("button",{class:C(["tab",{active:n.value==="by-account"}]),onClick:e[1]||(e[1]=a=>n.value="by-account")}," By Account ",2),s("button",{class:C(["tab",{active:n.value==="refunds"}]),onClick:e[2]||(e[2]=a=>n.value="refunds")}," Refunds ",2),s("button",{class:C(["tab",{active:n.value==="disputes"}]),onClick:e[3]||(e[3]=a=>n.value="disputes")}," Disputes ",2)]),s("div",fe,[s("div",be,[s("div",pe,[s("div",ge,[e[9]||(e[9]=s("label",{class:"form-label"},"Date Range",-1)),m(q,{"model-value":p.value,options:Q,"onUpdate:modelValue":te},null,8,["model-value"]),S.value?(L(),I("div",ye,[s("div",_e,[s("div",De,[e[7]||(e[7]=s("label",{class:"form-label"},"Start Date",-1)),y(s("input",{type:"date",class:"form-input","onUpdate:modelValue":e[4]||(e[4]=a=>R.value=a)},null,512),[[F,R.value]])]),s("div",he,[e[8]||(e[8]=s("label",{class:"form-label"},"End Date",-1)),y(s("input",{type:"date",class:"form-input","onUpdate:modelValue":e[5]||(e[5]=a=>w.value=a)},null,512),[[F,w.value]])])]),s("div",{class:"date-actions"},[s("button",{class:"btn btn-secondary btn-sm",onClick:se},"Cancel"),s("button",{class:"btn btn-primary btn-sm",onClick:ae},"Apply")])])):B("",!0)]),s("div",ke,[e[10]||(e[10]=s("label",{class:"form-label"},"Account",-1)),m(q,{modelValue:i.value,"onUpdate:modelValue":e[6]||(e[6]=a=>i.value=a),options:j.value},null,8,["modelValue","options"])])]),s("button",{class:"btn btn-primary mt-4",onClick:D,disabled:o.value},[o.value?(L(),I("span",we)):B("",!0),re(" "+A(o.value?"Loading...":"Generate Report"),1)],8,Re)])]),y(s("div",null,[m(x,{stats:G.value,loading:o.value},null,8,["stats","loading"]),s("div",Se,[s("div",Ce,[e[11]||(e[11]=s("h3",{class:"card-title"},"Transaction Summary",-1)),s("p",Ae," Showing "+A(g.value.length.toLocaleString())+" charges, "+A(d.value.length.toLocaleString())+" refunds, and "+A(_.value.length.toLocaleString())+" disputes for the selected period. ",1)])])],512),[[T,n.value==="overview"]]),y(s("div",null,[m(N,{columns:H,data:Y.value,loading:o.value,"empty-message":"No account data available"},null,8,["data","loading"])],512),[[T,n.value==="by-account"]]),y(s("div",null,[m(x,{stats:P.value,columns:3,loading:o.value},null,8,["stats","loading"]),m(N,{columns:J,data:W.value,loading:o.value,"empty-message":"No refunds found"},null,8,["data","loading"])],512),[[T,n.value==="refunds"]]),y(s("div",null,[m(x,{stats:z.value,loading:o.value},null,8,["stats","loading"]),m(N,{columns:K,data:X.value,loading:o.value,"empty-message":"No disputes found"},null,8,["data","loading"])],512),[[T,n.value==="disputes"]])])]))}},Ne=ne(Te,[["__scopeId","data-v-221395a1"]]);export{Ne as default};

import{_ as L,r,i as b,o as M,c as k,e as t,k as D,w as c,v,q as g,n as P,t as R,s as B,x as F,f as T,g as $,m as z,p as Q,h as C}from"./index-6BX6ZuWm.js";import{D as j}from"./DataTable-B2-9Iu5t.js";import{M as G}from"./Modal-MJNwM8ZE.js";const H={class:"main-content"},J={class:"container"},K={class:"page-header"},O={class:"card mb-4"},W={class:"card-body"},X={class:"form-group",style:{"margin-bottom":"0"}},Y={class:"form-group"},Z={class:"form-group"},ee={class:"form-group"},ae=["disabled"],te={key:0,class:"loading-spinner"},se={__name:"RefundsView",setup(oe){const{supabase:i}=z(),{success:I,error:f}=Q(),m=r(!1),d=r(""),p=r([]),y=r([]),n=r(!1),l=r(!1),o=r({chargeId:"",amount:"",reason:"requested_by_customer"}),V=b(()=>{const a={};return y.value.forEach(e=>{a[e.account_id]=e.account_name||e.account_id}),a}),S=[{key:"refund_id",label:"Refund ID",sortable:!0},{key:"charge_id",label:"Charge ID",sortable:!0},{key:"account",label:"Account",sortable:!0},{key:"amount",label:"Amount",sortable:!0},{key:"status",label:"Status",sortable:!0},{key:"reason",label:"Reason",sortable:!0},{key:"date",label:"Date",sortable:!0}],U=b(()=>{if(!d.value)return p.value;const a=d.value.toLowerCase();return p.value.filter(e=>{var s,u,w;return((s=e.refund_id)==null?void 0:s.toLowerCase().includes(a))||((u=e.charge_id)==null?void 0:u.toLowerCase().includes(a))||((w=e.account)==null?void 0:w.toLowerCase().includes(a))})}),x=b(()=>U.value.map(a=>{var e,s,u;return{refund_id:((e=a.stripe_refund_id)==null?void 0:e.substring(0,15))||((s=a.id)==null?void 0:s.substring(0,15)),charge_id:((u=a.stripe_charge_id)==null?void 0:u.substring(0,15))||"N/A",account:V.value[a.account_id]||a.account_id||"Unknown",amount:N((a.amount||0)/100),status:a.status||"Unknown",reason:A(a.reason),date:q(a.created_at)}}));function N(a){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(a)}function q(a){return a?new Date(a).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"}):"N/A"}function A(a){return a?a.replace(/_/g," ").replace(/\b\w/g,e=>e.toUpperCase()):"N/A"}async function E(){try{const{data:a,error:e}=await i.from("payment_accounts").select("account_id, account_name, payment_provider").eq("is_active",!0);if(e)throw e;y.value=a||[]}catch(a){console.error("Error loading accounts:",a)}}async function _(){m.value=!0;try{const{data:a,error:e}=await i.from("stripe_refunds").select("*").order("created_at",{ascending:!1}).limit(500);if(e)throw e;p.value=a||[]}catch(a){console.error("Error loading refunds:",a),f("Error loading refunds. Please try again.")}finally{m.value=!1}}async function h(){if(!o.value.chargeId){f("Please enter a charge ID");return}l.value=!0;try{const{data:a,error:e}=await i.functions.invoke("stripe-refund-lookup",{body:{charge_id:o.value.chargeId,amount:o.value.amount?parseInt(o.value.amount)*100:null,reason:o.value.reason}});if(e)throw e;I("Refund processed successfully"),n.value=!1,o.value={chargeId:"",amount:"",reason:"requested_by_customer"},_()}catch(a){console.error("Error processing refund:",a),f(a.message||"Error processing refund")}finally{l.value=!1}}return M(()=>{E(),_()}),(a,e)=>(C(),k("div",H,[t("div",J,[t("div",K,[e[7]||(e[7]=t("div",null,[t("h1",{class:"page-title"},"Refunds"),t("p",{class:"page-subtitle"},"View and process refunds")],-1)),t("button",{class:"btn btn-primary",onClick:e[0]||(e[0]=s=>n.value=!0)}," Process Refund ")]),t("div",O,[t("div",W,[t("div",X,[e[8]||(e[8]=t("label",{class:"form-label"},"Search Refunds",-1)),c(t("input",{type:"text",class:"form-input","onUpdate:modelValue":e[1]||(e[1]=s=>d.value=s),placeholder:"Search by refund ID, charge ID, or account..."},null,512),[[v,d.value]])])])]),D(j,{columns:S,data:x.value,loading:m.value,"empty-message":"No refunds found"},{"cell-status":g(({value:s})=>[t("span",{class:P(["badge",{"badge-success":s==="succeeded","badge-warning":s==="pending","badge-error":s==="failed"}])},R(s),3)]),_:1},8,["data","loading"]),D(G,{modelValue:n.value,"onUpdate:modelValue":e[6]||(e[6]=s=>n.value=s),title:"Process Refund"},{footer:g(()=>[t("button",{class:"btn btn-secondary",onClick:e[5]||(e[5]=s=>n.value=!1)},"Cancel"),t("button",{class:"btn btn-primary",onClick:h,disabled:l.value},[l.value?(C(),k("span",te)):T("",!0),$(" "+R(l.value?"Processing...":"Process Refund"),1)],8,ae)]),default:g(()=>[t("form",{onSubmit:B(h,["prevent"])},[t("div",Y,[e[9]||(e[9]=t("label",{class:"form-label"},"Charge ID *",-1)),c(t("input",{type:"text",class:"form-input","onUpdate:modelValue":e[2]||(e[2]=s=>o.value.chargeId=s),placeholder:"ch_...",required:""},null,512),[[v,o.value.chargeId]])]),t("div",Z,[e[10]||(e[10]=t("label",{class:"form-label"},"Amount (optional)",-1)),c(t("input",{type:"number",class:"form-input","onUpdate:modelValue":e[3]||(e[3]=s=>o.value.amount=s),placeholder:"Leave blank for full refund",step:"0.01"},null,512),[[v,o.value.amount]]),e[11]||(e[11]=t("p",{class:"form-hint"},"Leave blank for full refund",-1))]),t("div",ee,[e[13]||(e[13]=t("label",{class:"form-label"},"Reason",-1)),c(t("select",{class:"form-select","onUpdate:modelValue":e[4]||(e[4]=s=>o.value.reason=s)},[...e[12]||(e[12]=[t("option",{value:"requested_by_customer"},"Requested by Customer",-1),t("option",{value:"duplicate"},"Duplicate",-1),t("option",{value:"fraudulent"},"Fraudulent",-1)])],512),[[F,o.value.reason]])])],32)]),_:1},8,["modelValue"])])]))}},ue=L(se,[["__scopeId","data-v-99ab3e15"]]);export{ue as default};

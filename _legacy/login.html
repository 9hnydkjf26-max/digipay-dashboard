<!DOCTYPE html>
<html lang="en">
<!--
    IMPORTANT: This file must be served via HTTP/HTTPS, not opened directly as a file.
    
    To test locally, use one of these methods:
    1. Python: python -m http.server 8000
    2. Node.js: npx http-server
    3. PHP: php -S localhost:8000
    
    Then visit: http://localhost:8000/login.html
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiPay - Sign In</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --color-bg: #f8f9fa;
            --color-white: #ffffff;
            --color-text: #1a1a1a;
            --color-text-secondary: #6b7280;
            --color-text-tertiary: #9ca3af;
            --color-primary: #635bff;
            --color-primary-hover: #5851ec;
            --color-border: #e5e7eb;
            --color-error: #dc2626;
            --color-success: #16a34a;
            --radius: 8px;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --color-bg: #0f1419;
                --color-white: #1e2936;
                --color-text: #e3e8ee;
                --color-text-secondary: #9ca9b3;
                --color-text-tertiary: #697386;
                --color-primary: #7c3aed;
                --color-primary-hover: #6d28d9;
                --color-border: #2d3748;
                --color-error: #ef4444;
                --color-success: #22c55e;
            }
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: var(--color-bg);
            color: var(--color-text);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .login-container {
            width: 100%;
            max-width: 480px;
        }

        .card {
            background: var(--color-white);
            border: 1px solid var(--color-border);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        .card-content {
            padding: 48px 40px;
        }

        .logo-container {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-container img {
            height: 48px;
            width: auto;
            margin-bottom: 16px;
        }

        .logo-container h2 {
            font-size: 20px;
            font-weight: 600;
            margin: 0 0 8px 0;
            color: var(--color-text);
        }

        .logo-container p {
            font-size: 15px;
            color: var(--color-text-secondary);
            margin: 0;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-text);
        }

        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            font-size: 15px;
            font-family: inherit;
            color: var(--color-text);
            background: var(--color-bg);
            transition: all 0.15s;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(99, 91, 255, 0.1);
        }

        .form-group input:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .password-hint {
            font-size: 12px;
            color: var(--color-text-tertiary);
            margin-top: 6px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--color-primary);
            color: white;
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--color-primary-hover);
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 24px;
            font-size: 14px;
        }

        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--color-error);
            border: 1px solid rgba(220, 38, 38, 0.2);
        }

        .alert-success {
            background: rgba(22, 163, 74, 0.1);
            color: var(--color-success);
            border: 1px solid rgba(22, 163, 74, 0.2);
        }

        .hidden {
            display: none !important;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top-color: currentColor;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: 8px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 480px) {
            .card-content {
                padding: 32px 24px;
            }

            .logo-container {
                margin-bottom: 32px;
            }

            .logo-container img {
                height: 40px;
            }
        }
    </style>
</head>
<body>
    <div class="login-container">
        <div class="card">
            <div class="card-content">
                <div class="logo-container">
                    <img src="digipaylogo.svg" alt="DigiPay Logo">
                    <h2 id="formTitle">Sign In</h2>
                    <p id="formSubtitle">Sign in to access your dashboard</p>
                </div>

                <div class="alert hidden" id="alertBox"></div>

                <!-- Login Form -->
                <form id="loginForm" method="POST" action="javascript:void(0);">
                    <div class="form-group">
                        <label for="loginEmail">Email Address</label>
                        <input 
                            type="email" 
                            id="loginEmail" 
                            name="email"
                            required 
                            placeholder="your@email.com" 
                            aria-label="Email address"
                            autocomplete="email">
                    </div>
                    
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input 
                            type="password" 
                            id="loginPassword" 
                            name="password"
                            required 
                            placeholder="Enter your password"
                            aria-label="Password"
                            autocomplete="current-password">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="signInBtn">Sign In</button>
                </form>

                <!-- Set Password Form (for invited users) -->
                <form id="setPasswordForm" class="hidden" method="POST" action="javascript:void(0);">
                    <div class="form-group">
                        <label for="userEmail">Email Address</label>
                        <input 
                            type="email" 
                            id="userEmail" 
                            disabled
                            aria-label="Email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="newPassword">Create Password</label>
                        <input 
                            type="password" 
                            id="newPassword" 
                            name="newPassword"
                            required 
                            placeholder="Create a password"
                            aria-label="New password"
                            autocomplete="new-password"
                            minlength="6">
                        <p class="password-hint">Must be at least 6 characters</p>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Confirm Password</label>
                        <input 
                            type="password" 
                            id="confirmPassword" 
                            name="confirmPassword"
                            required 
                            placeholder="Confirm your password"
                            aria-label="Confirm password"
                            autocomplete="new-password"
                            minlength="6">
                    </div>
                    
                    <button type="submit" class="btn btn-primary" id="setPasswordBtn">Set Password & Continue</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const SUPABASE_URL = 'https://hzdybwclwqkcobpwxzoo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6ZHlid2Nsd3FrY29icHd4em9vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxNzU4ODQsImV4cCI6MjA4MTc1MTg4NH0.e0mSI7Qp9sRaclOwP61guBNtwTVHYXc-TtVaUON67QU';
        
        console.log('Initializing Supabase...');
        const mySupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('Supabase client created');

        // DOM Elements
        const loginForm = document.getElementById('loginForm');
        const setPasswordForm = document.getElementById('setPasswordForm');
        const alertBox = document.getElementById('alertBox');
        const formTitle = document.getElementById('formTitle');
        const formSubtitle = document.getElementById('formSubtitle');

        // Show alert message
        function showAlert(message, type = 'error') {
            alertBox.textContent = message;
            alertBox.className = `alert alert-${type}`;
            alertBox.classList.remove('hidden');
        }

        // Hide alert
        function hideAlert() {
            alertBox.classList.add('hidden');
        }

        // Show login form
        function showLoginForm() {
            loginForm.classList.remove('hidden');
            setPasswordForm.classList.add('hidden');
            formTitle.textContent = 'Sign In';
            formSubtitle.textContent = 'Sign in to access your dashboard';
        }

        // Show set password form
        function showSetPasswordForm(email) {
            loginForm.classList.add('hidden');
            setPasswordForm.classList.remove('hidden');
            formTitle.textContent = 'Welcome!';
            formSubtitle.textContent = 'Create a password to complete your account setup';
            
            if (email) {
                document.getElementById('userEmail').value = email;
            }
        }

        // Handle invite/recovery tokens in URL
        async function handleAuthTokens() {
            // Check for tokens in URL hash (Supabase PKCE flow)
            const hashParams = new URLSearchParams(window.location.hash.substring(1));
            const queryParams = new URLSearchParams(window.location.search);
            
            // Check for error in URL
            const error = hashParams.get('error') || queryParams.get('error');
            const errorDescription = hashParams.get('error_description') || queryParams.get('error_description');
            
            if (error) {
                showAlert(errorDescription || error, 'error');
                return false;
            }

            // Check for access_token (indicates successful token exchange)
            const accessToken = hashParams.get('access_token');
            const refreshToken = hashParams.get('refresh_token');
            const type = hashParams.get('type');
            
            // Also check for token_hash (older flow)
            const tokenHash = queryParams.get('token_hash');
            const tokenType = queryParams.get('type');

            console.log('Auth check:', { accessToken: !!accessToken, type, tokenHash: !!tokenHash, tokenType });

            // If we have access_token in hash (PKCE flow completed)
            if (accessToken && refreshToken) {
                try {
                    // Set the session manually
                    const { data, error } = await mySupabase.auth.setSession({
                        access_token: accessToken,
                        refresh_token: refreshToken
                    });

                    if (error) throw error;

                    if (data.session) {
                        // Check if this is an invite or recovery - show password form
                        if (type === 'invite' || type === 'recovery' || type === 'signup') {
                            showSetPasswordForm(data.session.user.email);
                            // Clean up URL
                            window.history.replaceState({}, document.title, window.location.pathname);
                            return true;
                        }
                    }
                } catch (err) {
                    console.error('Error setting session:', err);
                    showAlert('Error processing invite link. Please try again or contact support.', 'error');
                }
            }

            // If we have token_hash in query params (older flow)
            if (tokenHash && tokenType) {
                try {
                    const { data, error } = await mySupabase.auth.verifyOtp({
                        token_hash: tokenHash,
                        type: tokenType
                    });

                    if (error) throw error;

                    if (data.session) {
                        showSetPasswordForm(data.session.user.email);
                        // Clean up URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        return true;
                    }
                } catch (err) {
                    console.error('Error verifying token:', err);
                    showAlert('Invalid or expired invite link. Please request a new invitation.', 'error');
                }
            }

            return false;
        }

        // Check existing session
        async function checkSession() {
            const { data: { session } } = await mySupabase.auth.getSession();
            
            if (session) {
                // Check if user needs to set password (invited but no password set)
                // This is indicated by identities array being empty or missing
                const needsPassword = !session.user.user_metadata?.password_set && 
                                     session.user.app_metadata?.provider === 'email';
                
                if (needsPassword) {
                    showSetPasswordForm(session.user.email);
                    return;
                }
                
                // Already logged in with password set - redirect
                console.log('Session found, redirecting...');
                const redirectTo = new URLSearchParams(window.location.search).get('redirect') || 'reports.html';
                window.location.href = redirectTo;
            }
        }

        // Handle regular login
        async function handleLogin(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const signInBtn = document.getElementById('signInBtn');
            
            hideAlert();
            signInBtn.disabled = true;
            signInBtn.innerHTML = '<span class="loading-spinner"></span>Signing in...';
            
            try {
                const { data, error } = await mySupabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });
                
                if (error) throw error;
                
                console.log('Login successful, redirecting...');
                const redirectTo = new URLSearchParams(window.location.search).get('redirect') || 'reports.html';
                window.location.href = redirectTo;
                
            } catch (error) {
                console.error('Login error:', error);
                showAlert(error.message || 'Invalid email or password', 'error');
                signInBtn.disabled = false;
                signInBtn.textContent = 'Sign In';
            }
        }

        // Handle set password
        async function handleSetPassword(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const setPasswordBtn = document.getElementById('setPasswordBtn');
            
            hideAlert();

            // Validate passwords match
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }

            // Validate password length
            if (newPassword.length < 6) {
                showAlert('Password must be at least 6 characters', 'error');
                return;
            }
            
            setPasswordBtn.disabled = true;
            setPasswordBtn.innerHTML = '<span class="loading-spinner"></span>Setting password...';
            
            try {
                // Update the user's password
                const { data, error } = await mySupabase.auth.updateUser({
                    password: newPassword
                });
                
                if (error) throw error;
                
                showAlert('Password set successfully! Redirecting...', 'success');
                
                // Redirect after short delay
                setTimeout(() => {
                    const redirectTo = new URLSearchParams(window.location.search).get('redirect') || 'reports.html';
                    window.location.href = redirectTo;
                }, 1500);
                
            } catch (error) {
                console.error('Set password error:', error);
                showAlert(error.message || 'Error setting password. Please try again.', 'error');
                setPasswordBtn.disabled = false;
                setPasswordBtn.textContent = 'Set Password & Continue';
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('DOM loaded, checking for auth tokens...');
            
            // First, handle any auth tokens in URL
            const hasTokens = await handleAuthTokens();
            
            // If no tokens were processed, check for existing session
            if (!hasTokens) {
                await checkSession();
            }

            // Attach form handlers
            loginForm.addEventListener('submit', handleLogin);
            setPasswordForm.addEventListener('submit', handleSetPassword);
        });

        // Listen for auth state changes
        mySupabase.auth.onAuthStateChange(async (event, session) => {
            console.log('Auth state changed:', event);
            
            if (event === 'SIGNED_IN' && session) {
                // Don't auto-redirect if we're showing the password form
                if (!setPasswordForm.classList.contains('hidden')) {
                    return;
                }
            }
        });
    </script>
</body>
</html>
